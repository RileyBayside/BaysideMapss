
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside — Sign in</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#0f172a;}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#0f172a}
    .wrap{max-width:720px;margin:56px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(16,24,40,.08);padding:28px 24px}
    .logo{display:block;margin:8px auto 12px auto;height:58px}
    .badge{display:block;text-align:center;border:1px solid #e5e7eb;background:#f8fafc;border-radius:12px;padding:8px 12px;margin:8px auto 18px auto;max-width:240px;font-weight:600}
    h1{font-size:24px;text-align:center;margin:0 0 8px 0}
    .tabs{display:flex;gap:8px;margin:12px 0 18px}
    .tab{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc;text-align:center;font-weight:600;cursor:pointer}
    .tab.active{background:#0f172a;color:#fff}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,button{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
    input:focus{outline:3px solid #e5efff;border-color:#94a3b8}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .btn{background:#0f172a;color:#fff;border:0;font-weight:700;cursor:pointer}
    .btn.outline{background:#fff;color:#0f172a;border:1px solid #cbd5e1}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .err{color:#b42318;background:#fee4e2;border:1px solid #fecdca;padding:8px 10px;border-radius:10px;display:none;margin-top:12px}
    .info{color:#0f172a;background:#eef2ff;border:1px solid #c7d2fe;padding:10px 12px;border-radius:10px;display:none;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <img class="logo" src="assets/bayside-logo.png" alt="Bayside Slashing" onerror="this.style.display='none'">
      <div class="badge">Secure Sign‑in</div>
      <h1>Welcome</h1>

      <div id="signedInBox" class="info">
        You’re already signed in. Choose:
        <div class="row mt12">
          <button id="continueBtn" class="btn">Continue to dashboard</button>
          <button id="signOutBtn" class="btn outline">Sign out</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Sign in method">
        <button id="tab-operator" class="tab active" role="tab" aria-selected="true">Operator (Username + Password)</button>
        <button id="tab-admin" class="tab" role="tab" aria-selected="false">Admin (Email + Password)</button>
      </div>

      <form id="loginForm" autocomplete="on">
        <label id="lbl-email" for="email">Username</label>
        <input id="email" name="email" type="text" autocomplete="username" placeholder="e.g., riley" required />
        <label for="password">Password</label>
        <input id="password" name="password" type="password" minlength="6" autocomplete="current-password" placeholder="Your password" required class="mt8"/>
        <div id="error" class="err"></div>
        <button type="submit" class="btn mt16">Sign in</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>

  <script>
    (function(){
      // Where to go after login
      function getNextUrl(){
        try{
          const p = new URLSearchParams(window.location.search);
          const next = p.get('next');
          if(next){
            const u = new URL(next, window.location.href);
            if (u.origin === window.location.origin && !/login\.html$/i.test(u.pathname)) {
              return u.pathname + u.search + u.hash;
            }
          }
        }catch(e){}
        return 'index.html';
      }
      function goNext(){
        const target = getNextUrl();
        // set a short-lived token to avoid accidental loops
        sessionStorage.setItem('bs_last_redirect', Date.now().toString());
        window.location.replace(target);
        setTimeout(()=>{ window.location.href = target; }, 300);
      }

      const opTab = document.getElementById('tab-operator');
      const adTab = document.getElementById('tab-admin');
      const email = document.getElementById('email');
      const lblEmail = document.getElementById('lbl-email');
      const form = document.getElementById('loginForm');
      const errBox = document.getElementById('error');

      function setMode(mode){
        if(mode === 'operator'){
          opTab.classList.add('active'); adTab.classList.remove('active');
          lblEmail.textContent = 'Username';
          email.type='text'; email.placeholder='e.g., riley'; email.setAttribute('autocomplete','username');
          email.dataset.mode='operator';
        }else{
          adTab.classList.add('active'); opTab.classList.remove('active');
          lblEmail.textContent = 'Email';
          email.type='email'; email.placeholder='riley@baysideslashing.com.au'; email.setAttribute('autocomplete','username');
          email.dataset.mode='admin';
        }
      }
      opTab.onclick=()=>setMode('operator');
      adTab.onclick=()=>setMode('admin');
      setMode('operator');

      // Auto-switch to Admin if an '@' is typed
      email.addEventListener('input', () => {
        if (email.value.includes('@')) setMode('admin');
      });

      // Do NOT auto-redirect on auth state (prevents refresh loops).
      // Instead, show a gentle "Continue" / "Sign out" choice.
      const signedInBox = document.getElementById('signedInBox');
      const continueBtn = document.getElementById('continueBtn');
      const signOutBtn = document.getElementById('signOutBtn');

      firebase.auth().onAuthStateChanged(u => {
        if (u) {
          signedInBox.style.display = 'block';
          continueBtn.onclick = () => goNext();
          signOutBtn.onclick = async () => {
            try { await firebase.auth().signOut(); } finally { location.reload(); }
          };
        } else {
          signedInBox.style.display = 'none';
        }
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        errBox.style.display='none'; errBox.textContent='';
        const raw = email.value.trim();
        const pass = document.getElementById('password').value;
        if(!raw || !pass){ return; }

        const isEmail = raw.includes('@');
        const signinEmail = isEmail ? raw : `${raw.toLowerCase()}@bayside.local`;

        try{
          await firebase.auth().signInWithEmailAndPassword(signinEmail, pass);
          goNext();
        }catch(err){
          console.warn(err);
          errBox.textContent = 'Sign-in failed: ' + (err && err.message ? err.message : String(err));
          errBox.style.display='block';
        }
      });
    })();
  </script>
</body>
</html>
