<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside — Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght:400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24; --focus:#e6f0ff;
      --chip:#f1f5f9; --chip-ink:#334155;
      --ok:#16a34a; --ok-ink:#064e3b;
      --warn:#f59e0b; --warn-ink:#78350f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 22px; background:#fff; border-bottom:1px solid var(--muted); position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:14px }
    .brand img{ height:56px; display:block }
    .title{ font-size:22px; font-weight:800; color:var(--ink-2) }
    .userbox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .email{ font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0; padding:8px 10px; border-radius:10px; }
    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff; background:var(--ink); }
    .btn:hover{ background:#1f2937 }

    /* Layout */
    .container{ max-width:1200px; margin: 20px auto; padding: 0 16px }
    .grid{ display:grid; gap:16px }

    /* Work areas */
    .areas{ display:grid; grid-template-columns: repeat(3, 1fr); gap:16px }
    .area{ background:#fff; border:1px solid var(--muted); border-radius:16px; overflow:hidden; box-shadow:0 8px 26px rgba(16,24,40,.08); }
    .area .thumb{ height:180px; background:#e5e7eb; position:relative; overflow:hidden }
    .area .thumb img{ width:100%; height:100%; object-fit:cover; display:block; filter:saturate(0.85) }
    .area .thumb .label{
      position:absolute; inset:auto 16px 14px 16px; color:#fff; font-weight:800; font-size:34px; letter-spacing:.6px;
      text-shadow:0 3px 16px rgba(0,0,0,.65);
    }
    .area .row{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px }
    .area .open{ background:var(--ink); color:#fff; border:0; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer }
    .area .open:hover{ background:#1f2937 }

    /* Tasks section */
    .card{ background:var(--card); border:1px solid var(--muted); border-radius:16px; box-shadow:0 8px 26px rgba(16,24,40,.08); }
    .card h3{ margin:14px 16px 6px; font-size:18px; font-weight:800; color:var(--ink-2) }
    .card .body{ padding: 0 16px 16px }

    .tasks{ display:grid; gap:12px; margin-top:10px }
    .task-card{
      background:#fff; border:1px solid var(--muted); border-radius:14px; padding:12px; display:grid; gap:10px;
    }
    .task-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .task-title{ font-weight:800; color:var(--ink-2) }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--chip); color:var(--chip-ink); border:1px solid #e2e8f0;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
    }
    .chip.small{ padding:4px 8px; font-weight:600 }
    .chip.warn{ background:#fef3c7; color:var(--warn-ink); border-color:#fde68a }
    .chip.ok{ background:#dcfce7; color:var(--ok-ink); border-color:#bbf7d0 }

    .actions{ display:flex; align-items:center; gap:10px; }
    .btn-accent{ background:var(--accent) }
    .btn-accent:hover{ background:var(--accent-600) }
    .btn-ghost{
      background:#475569; color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer;
    }
    .empty{
      border:1px dashed #cbd5e1; border-radius:12px; background:#f8fafc; color:#64748b;
      padding:16px; text-align:center; font-weight:600;
    }

    @media (max-width:1100px){
      .areas{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Firebase SDKs & guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside logo" onerror="this.style.display='none'">
      <div class="title">Dashboard</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">—</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container grid">
    <!-- Work areas -->
    <section class="areas">
      <article class="area">
        <div class="thumb">
          <img src="thumbs/mowing.jpg" alt="Mowing" onerror="this.style.display='none'">
          <div class="label">MOWING</div>
        </div>
        <div class="row">
          <div>Parks Mowing</div>
          <a class="open" href="ParksMowing.html">Open</a>
        </div>
      </article>

      <article class="area">
        <div class="thumb">
          <img src="thumbs/snipping.jpg" alt="Snipping" onerror="this.style.display='none'">
          <div class="label">SNIPPING</div>
        </div>
        <div class="row">
          <div>Parks Snipping</div>
          <a class="open" href="ParksSnipping.html">Open</a>
        </div>
      </article>

      <article class="area">
        <div class="thumb">
          <img src="thumbs/firebreaks.jpg" alt="Firebreaks" onerror="this.style.display='none'">
          <div class="label">FIREBREAKS</div>
        </div>
        <div class="row">
          <div>Firebreaks</div>
          <a class="open" href="Firebreaks.html">Open</a>
        </div>
      </article>
    </section>

    <!-- Tasks -->
    <section class="card">
      <h3>Tasks to complete</h3>
      <div class="body">
        <div id="tasksList" class="tasks"></div>
        <div id="tasksError" class="empty" style="display:none">Failed to load tasks</div>
      </div>
    </section>
  </main>

  <script>
    const db = firebase.firestore();

    // -- Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await firebase.auth().signOut(); location.href = 'login.html'; }
      catch (e) { console.warn(e); }
    });

    // -- Display operator name in the pill (safe even if users doc missing)
    async function setDisplayName(u) {
      const el = document.getElementById('userEmail');
      if (!el) return;

      el.textContent = 'Signed in';
      try {
        const doc = await db.collection('users').doc(u.uid).get();
        const d = doc.data() || {};
        const display =
          d.name ||
          d.username ||
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;
        el.textContent = display;
      } catch (_) {
        el.textContent =
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;
      }
    }

    // --- Helpers for tasks UI ---
    function fmtDate(ts){
      if (!ts) return '';
      // support Firestore Timestamp or Date
      const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
      if (!d) return '';
      return d.toLocaleDateString(undefined, { month:'short', day:'numeric' });
    }

    function groupByZone(docs){
      const map = new Map();
      docs.forEach(d=>{
        const z = d.zone || 'Unzoned';
        if(!map.has(z)) map.set(z, []);
        map.get(z).push(d);
      });
      return [...map.entries()].map(([zone, rows])=>({ zone, rows }));
    }

    function renderTasks(docs){
      const root = document.getElementById('tasksList');
      const err  = document.getElementById('tasksError');
      root.innerHTML = '';

      const active = docs.filter(d => (d.status || 'assigned') !== 'done');
      if (!active.length){
        err.style.display = 'block';
        err.textContent = 'No tasks assigned yet.';
        return;
      }
      err.style.display = 'none';

      const groups = groupByZone(active);
      groups.forEach(g=>{
        // summary
        const anyInProgress = g.rows.some(r => r.status === 'in_progress');
        const earliestDue = g.rows
          .map(r => r.dueDate)
          .filter(Boolean)
          .sort((a,b)=> (a.toMillis?a.toMillis():a) - (b.toMillis?b.toMillis():b))[0];

        const card = document.createElement('div');
        card.className = 'task-card';

        const head = document.createElement('div');
        head.className = 'task-head';

        const title = document.createElement('div');
        title.className = 'task-title';
        title.textContent = g.zone;
        head.appendChild(title);

        const actions = document.createElement('div');
        actions.className = 'actions';
        const primary = document.createElement('button');
        primary.className = 'btn-accent';
        primary.textContent = anyInProgress ? 'Mark done' : 'Start';
        primary.style.minWidth = '108px';
        primary.onclick = async () => {
          try{
            const batch = db.batch();
            g.rows.forEach(r=>{
              const ref = db.collection('assignments').doc(r.id);
              const now = firebase.firestore.FieldValue.serverTimestamp();
              batch.update(ref, {
                status: anyInProgress ? 'done' : 'in_progress',
                lastUpdatedAt: now,
                lastUpdatedBy: firebase.auth().currentUser?.uid || null,
                ...(anyInProgress ? { completedAt: now } : {})
              });
            });
            await batch.commit();
          }catch(e){ console.warn('bulk status error', e); alert('Failed to update tasks'); }
        };
        actions.appendChild(primary);
        head.appendChild(actions);

        card.appendChild(head);

        // Status chips
        const chips = document.createElement('div');
        chips.className = 'chips';

        const statusChip = document.createElement('div');
        statusChip.className = 'chip ' + (anyInProgress ? 'ok' : 'warn');
        statusChip.textContent = anyInProgress ? 'In progress' : 'Assigned';
        chips.appendChild(statusChip);

        if (earliestDue){
          const due = document.createElement('div');
          due.className = 'chip small';
          due.textContent = 'Due ' + fmtDate(earliestDue);
          chips.appendChild(due);
        }

        card.appendChild(chips);

        // IDs
        const idChips = document.createElement('div');
        idChips.className = 'chips';
        g.rows.forEach(r=>{
          const ids = Array.isArray(r.siteIds) ? r.siteIds : [];
          if (ids.length === 0) {
            const c = document.createElement('div');
            c.className = 'chip small';
            c.textContent = '—';
            idChips.appendChild(c);
          } else {
            ids.forEach(id=>{
              const c = document.createElement('div');
              c.className = 'chip small';
              c.textContent = id;
              idChips.appendChild(c);
            });
          }
        });
        card.appendChild(idChips);

        root.appendChild(card);
      });
    }

    // Subscribe to my tasks (no composite index needed; filter status client-side)
    let tasksUnsub = null;
    function startTasksListener(uid){
      tasksUnsub?.();
      tasksUnsub = db.collection('assignments')
        .where('userId','==', uid)
        .orderBy('createdAt','desc')  // okay if createdAt is present; remove if not used
        .onSnapshot(
          (snap)=>{
            const rows = [];
            snap.forEach(doc=>{
              const d = doc.data() || {};
              rows.push({
                id: doc.id,
                userId: d.userId || '',
                zone: d.zone || '',
                siteIds: Array.isArray(d.siteIds) ? d.siteIds : [],
                status: d.status || 'assigned',
                dueDate: d.dueDate || null,
                createdAt: d.createdAt || null
              });
            });
            renderTasks(rows);
          },
          (err)=>{
            console.warn('tasks subscribe error', err);
            const errEl = document.getElementById('tasksError');
            errEl.style.display = 'block';
            errEl.textContent = 'Failed to load tasks';
          }
        );
    }

    // Auth gate for this page
    firebase.auth().onAuthStateChanged((u) => {
      if (!u) { location.href = 'login.html'; return; }
      setDisplayName(u);           // don’t block if profile lookup fails
      startTasksListener(u.uid);   // always start tasks listener when signed in
    });
  </script>
</body>
</html>
