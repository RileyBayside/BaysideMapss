<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mowing Areas Visualization</title>
    
    <!-- Mapbox GL JS and CSS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            color: #333;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 300px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1;
            backdrop-filter: blur(5px);
        }
        h2 {
            margin-top: 0;
            font-size: 1.5em;
            color: #1a1a1a;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-container label {
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        .search-input-wrapper {
            display: flex;
            gap: 8px;
        }
        #search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }
        #search-button {
            padding: 10px 15px;
            border: none;
            background-color: #007cbf;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color: 0.3s;
        }
        #search-button:hover {
            background-color: #005f99;
        }
        #legend {
            margin-top: 20px;
        }
        .legend-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .mapboxgl-popup-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
            font-family: 'Inter', sans-serif;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 5px 0;
            color: #007cbf;
        }
        .mapboxgl-popup-content p {
            margin: 0;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            font-size: 1.5em;
            font-weight: 500;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white;
            padding: 25px 35px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            text-align: center;
            max-width: 300px;
        }
        #modal-message {
            margin: 0 0 20px 0;
            font-size: 1.1em;
            color: #333;
        }
        #modal-close-button {
            padding: 10px 25px;
            border: none;
            background-color: #007cbf;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        #modal-close-button:hover {
            background-color: #005f99;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
    <h2>Mowing Areas</h2>
    <div class="search-container">
        <label for="search-input">Search by Mowing ID</label>
        <div class="search-input-wrapper">
            <input type="text" id="search-input" placeholder="e.g., M0312">
            <button id="search-button">Search</button>
        </div>
    </div>
    <div id="legend">
        <div class="legend-title">Cuts Per Year</div>
        <div id="legend-items"></div>
    </div>
</div>
<div id="loading" class="loading-overlay">
    <p>Loading map data...</p>
</div>
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <p id="modal-message"></p>
        <button id="modal-close-button">OK</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoicmlsZXliYXlzaWRlIiwiYSI6ImNtZmJwanh1NzI0NmIya29tYWF1Nm1keXcifQ.gM0QSnc4FBcPt7hCEFS4Vg';
    const GEOJSON_FILE = 'Good JSON File.json';
    const MOWING_DATA_SOURCE = 'mowing-data-source';
    const MOWING_AREAS_LAYER = 'mowing-areas-layer';
    const MOWING_HIGHLIGHT_LAYER = 'mowing-highlight-layer';

    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

    // --- MAP INITIALIZATION ---
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        center: [153.1, -27.6], // Initial center, will be updated after data loads
        zoom: 9
    });

    let geojsonData = null; // To store the processed GeoJSON data
    let highlightedFeatureId = null;

    // --- UTILITY FUNCTIONS ---

    /**
     * Parses the HTML description string to extract MowingID and cutsperyear.
     * @param {string} description - The HTML string from the GeoJSON properties.
     * @returns {object} An object containing mowingId and cutsPerYear.
     */
    const parseDescription = (description) => {
        const mowingIdMatch = description.match(/<td>MowingID<\/td><td>(.*?)<\/td>/);
        const cutsPerYearMatch = description.match(/<td>cutsperyear<\/td><td>(.*?)<\/td>/);
        return {
            mowingId: mowingIdMatch ? mowingIdMatch[1].trim() : 'N/A',
            cutsPerYear: cutsPerYearMatch ? cutsPerYearMatch[1].trim() : 'N/A'
        };
    };
    
    /**
     * Calculates the bounding box of a GeoJSON FeatureCollection.
     * @param {object} data - The GeoJSON FeatureCollection.
     * @returns {Array} A Mapbox LngLatBounds object.
     */
    function getBoundingBox(data) {
        const bounds = new mapboxgl.LngLatBounds();
        data.features.forEach(feature => {
            // This function recursively traverses the geometry coordinates
            const traverse = (coords) => {
                if (typeof coords[0] === 'number') {
                    bounds.extend(coords);
                } else {
                    coords.forEach(traverse);
                }
            };
            traverse(feature.geometry.coordinates);
        });
        return bounds;
    }

    /**
     * Creates and displays the map legend based on the loaded data.
     * @param {Map<string, string>} legendData - A map of 'cutsperyear' values to their colors.
     */
    const createLegend = (legendData) => {
        const legendContainer = document.getElementById('legend-items');
        legendContainer.innerHTML = ''; // Clear existing items

        // Sort legend items numerically by cuts per year
        const sortedLegend = new Map([...legendData.entries()].sort((a, b) => Number(a[0]) - Number(b[0])));

        for (const [cuts, color] of sortedLegend.entries()) {
            const item = document.createElement('div');
            item.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = color;
            
            const label = document.createElement('span');
            label.textContent = `${cuts} cuts`;
            
            item.appendChild(colorBox);
            item.appendChild(label);
            legendContainer.appendChild(item);
        }
    };

    // --- MAP EVENT HANDLING ---

    map.on('load', async () => {
        try {
            // 1. Fetch and process GeoJSON data
            const response = await fetch(GEOJSON_FILE);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            geojsonData = await response.json();
            
            const legendMap = new Map();

            // Process each feature to add top-level properties for easier access
            geojsonData.features.forEach((feature, index) => {
                feature.id = index; // Add a unique numeric ID for feature state
                const { mowingId, cutsPerYear } = parseDescription(feature.properties.description);
                feature.properties.MowingID = mowingId;
                feature.properties.cutsperyear = cutsPerYear;

                if (cutsPerYear !== 'N/A' && !legendMap.has(cutsPerYear)) {
                    legendMap.set(cutsPerYear, feature.properties.fill);
                }
            });

            // 2. Add data source to the map
            map.addSource(MOWING_DATA_SOURCE, {
                type: 'geojson',
                data: geojsonData,
                generateId: true // Important for feature state
            });

            // 3. Add layer for mowing area fills
            map.addLayer({
                id: MOWING_AREAS_LAYER,
                type: 'fill',
                source: MOWING_DATA_SOURCE,
                paint: {
                    'fill-color': ['get', 'fill'],
                    'fill-opacity': 0.7
                }
            });

            // 4. Add layer for area outlines
            map.addLayer({
                id: 'mowing-outlines-layer',
                type: 'line',
                source: MOWING_DATA_SOURCE,
                paint: {
                    'line-color': '#FFFFFF',
                    'line-width': 1,
                    'line-opacity': 0.5
                }
            });
            
            // 5. Add a dedicated layer for highlighting searched items
            map.addLayer({
                id: MOWING_HIGHLIGHT_LAYER,
                type: 'line',
                source: MOWING_DATA_SOURCE,
                paint: {
                    'line-color': '#FFFF00', // Bright yellow for highlight
                    'line-width': 4,
                    'line-opacity': 1
                },
                // Initially, this layer shows nothing
                filter: ['==', ['id'], '']
            });

            // 6. Create the legend
            createLegend(legendMap);

            // 7. Zoom map to fit all loaded data
            const bounds = getBoundingBox(geojsonData);
            map.fitBounds(bounds, { padding: 50 });

            // 8. Hide loading overlay
            document.getElementById('loading').style.display = 'none';

        } catch (error) {
            console.error('Failed to load map data:', error);
            document.getElementById('loading').innerHTML = `<p>Error loading data. Please check the console and ensure '${GEOJSON_FILE}' is in the same directory.</p>`;
        }
    });

    // --- INTERACTIVITY ---

    // Create a popup, but don't add it to the map yet.
    const popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    map.on('mouseenter', MOWING_AREAS_LAYER, (e) => {
        map.getCanvas().style.cursor = 'pointer';

        const feature = e.features[0];
        const coordinates = e.lngLat;
        const props = feature.properties;

        const popupHTML = `
            <h3>${props.MowingID}</h3>
            <p><strong>Cuts per year:</strong> ${props.cutsperyear}</p>
        `;

        popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
    });

    map.on('mouseleave', MOWING_AREAS_LAYER, () => {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });
    
    /**
     * Performs the search for a Mowing ID.
     */
    const performSearch = () => {
        const searchTerm = document.getElementById('search-input').value.trim().toUpperCase();
        if (!geojsonData) return;
        
        const foundFeature = geojsonData.features.find(
            f => f.properties.MowingID.toUpperCase() === searchTerm
        );

        if (foundFeature) {
            // Update the filter for the highlight layer to show only the found feature
            map.setFilter(MOWING_HIGHLIGHT_LAYER, ['==', ['id'], foundFeature.id]);
            
            // Calculate bounds of the single feature and fly to it
            const featureBounds = new mapboxgl.LngLatBounds();
            const traverse = (coords) => {
                if (typeof coords[0] === 'number') {
                    featureBounds.extend(coords);
                } else {
                    coords.forEach(traverse);
                }
            };
            traverse(foundFeature.geometry.coordinates);
            
            map.fitBounds(featureBounds, {
                padding: 100,
                maxZoom: 17
            });
        } else {
            // If not found, clear the highlight and alert the user
            map.setFilter(MOWING_HIGHLIGHT_LAYER, ['==', ['id'], '']);
            showModal(`Mowing ID "${searchTerm}" not found.`);
        }
    };

    // --- MODAL DIALOG LOGIC ---
    const modalOverlay = document.getElementById('modal-overlay');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseButton = document.getElementById('modal-close-button');

    function showModal(message) {
        modalMessage.textContent = message;
        modalOverlay.style.display = 'flex';
    }

    modalCloseButton.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
    });


    // --- EVENT LISTENERS for UI ---
    document.getElementById('search-button').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

</script>

</body>
</html>


