<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside – Dashboard</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">

  <!-- Page-specific styles for the Tasks card -->
  <style>
    :root{
      --ink:#0f172a; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24;
    }

    .task-link { color: inherit; text-decoration: none; }
    .task-link:hover { text-decoration: underline; }

    /* Card (delegate.html look) */
    .card{
      background:var(--card);
      border:1px solid var(--muted);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(16,24,40,.08);
    }
    .card h3{
      margin:14px 16px 10px;
      font-size:16px; font-weight:800; color:#0f172a;
      display:flex; align-items:center; gap:10px;
    }
    .card h3::before{
      content:""; width:10px; height:10px; border-radius:50%;
      background:var(--accent); display:inline-block;
    }
    .card .body{ padding:0 16px 16px; }

    /* Tasks list inside the card */
    .tasks-list{ display:grid; gap:8px; }
    .task-row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;
    }
    .task-main{ display:flex; flex-direction:column; flex:1 1 auto; min-width:0; }
    .task-title{ font-weight:800; color:#111827; }
    .task-meta{ color:#64748b; font-size:13px; margin-top:2px; }

    .badge{ border-radius:999px; padding:4px 8px; font-weight:800; font-size:12px; white-space:nowrap; }
    .badge-amber{ background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; }

    /* Notes block under each task */
    .task-note{
      margin-top:6px;
      padding:8px 10px;
      background:#f8fafc;
      border-left:3px solid var(--accent);
      border-radius:8px;
      color:#334155;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Right-side actions: keep pill & button neatly spaced */
    .task-actions{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
      white-space:nowrap;
    }
    .btn-small{
      padding:6px 10px;
      font-size:13px;
      border-radius:8px;
    }
  </style>
</head>
<body>

  <!-- Firebase + guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header / App Bar -->
  <header class="appbar">
    <div class="appbar__left">
      <img class="logo" src="logo.png" alt="Bayside Slashing" />
      <h1 class="appbar__title">Dashboard</h1>
    </div>

    <div class="appbar__right">
      <span class="user-pill" id="user-email">user@bayside.local</span>
      <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">

    <section class="section">
      <h2 class="section-title">Work areas</h2>

      <div class="cards-row">
        <!-- Parks Mowing -->
        <a href="./ParksMowing.html" class="work-card">
          <div class="work-card__img">
            <img src="MOWING PICTURE.png" alt="Parks Mowing map" />
          </div>
          <div class="work-card__footer">
            <span class="work-card__title">Parks Mowing</span>
            <span class="btn btn-dark">Open</span>
          </div>
        </a>

        <!-- Parks Snipping -->
        <a href="./ParksSnipping.html" class="work-card">
          <div class="work-card__img">
            <img src="SNIPPING PICTURE.png" alt="Parks Snipping map" />
          </div>
          <div class="work-card__footer">
            <span class="work-card__title">Parks Snipping</span>
            <span class="btn btn-dark">Open</span>
          </div>
        </a>

        <!-- Firebreaks -->
        <a href="./Firebreaks.html" class="work-card">
          <div class="work-card__img">
            <img src="FIREBREAKS PICTURE.png" alt="Firebreaks map" />
          </div>
          <div class="work-card__footer">
            <span class="work-card__title">Firebreaks</span>
            <span class="btn btn-dark">Open</span>
          </div>
        </a>
      </div>
    </section>

    <!-- Tasks to complete -->
    <section class="card" id="tasksCard">
      <h3>Tasks to complete</h3>
      <div class="body">
        <div id="tasks-list" class="tasks-list"></div>
      </div>
    </section>

  </main>

  <footer class="footer-space"></footer>

  <!-- Display name + logout -->
  <script>
    (function () {
      async function setDisplayName(u) {
        const el = document.getElementById('user-email');
        if (!el) return;

        el.textContent = 'Signed in'; // temporary while loading
        try {
          const snap = await firebase.firestore().collection('users').doc(u.uid).get();
          const d = snap.data() || {};
          const display =
            d.name || d.username || u.displayName ||
            (u.email ? u.email.split('@')[0] : '') || u.email || u.uid;
          el.textContent = display;
        } catch {
          el.textContent =
            u.displayName || (u.email ? u.email.split('@')[0] : '') || u.email || u.uid;
        }
      }

      firebase.auth().onAuthStateChanged((u) => { if (u) setDisplayName(u); });

      window.logout = async function () {
        try { await firebase.auth().signOut(); } catch (e) { console.warn(e); }
        try { sessionStorage.removeItem('bayside_next'); localStorage.removeItem('bayside_next'); } catch {}
        location.replace('./login.html');
      };

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', () => window.logout());
    })();
  </script>

  <!-- Tasks: live listener + renderer (marks task in_progress on open) -->
  <script>
    (function () {
      const db = firebase.firestore();

      async function markTaskStarted(taskId) {
        const uid = firebase.auth().currentUser?.uid || null;
        const ref = db.collection('assignments').doc(taskId);
        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            if (!snap.exists) return;
            const d = snap.data() || {};
            if (d.status === 'completed') return;
            if (d.status !== 'in_progress') {
              tx.update(ref, {
                status: 'in_progress',
                startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                startedBy: uid
              });
            } else {
              tx.update(ref, { lastOpenedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
        } catch (e) {
          console.warn('markTaskStarted failed:', e);
        }
      }

      function renderTasks(items) {
        const el = document.getElementById('tasks-list');
        if (!el) return;

        el.innerHTML = '';
        if (!items.length) {
          const p = document.createElement('p');
          p.style.color = '#64748b';
          p.textContent = 'No tasks assigned yet.';
          el.appendChild(p);
          return;
        }

        items.forEach((t) => {
          const row = document.createElement('div');
          row.className = 'task-row';

          const left = document.createElement('div');
          left.className = 'task-main';

          const ids = Array.isArray(t.siteIds) ? t.siteIds.map(s => String(s).toUpperCase()) : [];
          const focus = ids.join(',');
          const dest = focus
            ? `AssignedParks.html?focus=${encodeURIComponent(focus)}&task=${encodeURIComponent(t.id)}`
            : `AssignedParks.html?task=${encodeURIComponent(t.id)}`;

          const title = document.createElement('div');
          title.className = 'task-title';

          const a = document.createElement('a');
          a.className = 'task-link';
          a.title = 'Open these in the map';
          a.href = dest;
          a.textContent = (t.zone || 'Task') + (ids.length ? ` — ${ids.join(', ')}` : '');
          a.addEventListener('click', async (ev) => {
            ev.preventDefault();
            try { await markTaskStarted(t.id); } catch {}
            location.href = dest;
          });
          title.appendChild(a);
          left.appendChild(title);

          const meta = document.createElement('div');
          meta.className = 'task-meta';
          const dueDate = t.dueDate?.toDate ? t.dueDate.toDate()
                       : (t.dueDate instanceof Date ? t.dueDate : null);
          meta.textContent = dueDate ? `Due ${dueDate.toLocaleDateString()}` : 'Assigned';
          left.appendChild(meta);

          if (t.notes && String(t.notes).trim()) {
            const note = document.createElement('div');
            note.className = 'task-note';
            note.textContent = String(t.notes).trim();
            left.appendChild(note);
          }

          const right = document.createElement('div');
          right.className = 'task-actions';

          const badge = document.createElement('span');
          badge.className = 'badge badge-amber';
          const s = (t.status || 'assigned').replace('_',' ');
          badge.textContent = s.charAt(0).toUpperCase() + s.slice(1);
          right.appendChild(badge);

          const openBtn = document.createElement('a');
          openBtn.href = dest;
          openBtn.className = 'btn btn-dark btn-small';
          openBtn.textContent = 'Open';
          openBtn.addEventListener('click', async (ev) => {
            ev.preventDefault();
            try { await markTaskStarted(t.id); } catch {}
            location.href = dest;
          });
          right.appendChild(openBtn);

          row.appendChild(left);
          row.appendChild(right);
          el.appendChild(row);
        });
      }

      window.startTasksListener = function (uid) {
        return db.collection('assignments')
          .where('userId', '==', uid)
          .onSnapshot((snap) => {
            const items = [];
            snap.forEach(doc => {
              const d = doc.data() || {};
              if ((d.status || 'assigned').toLowerCase() === 'completed') return;
              items.push({ id: doc.id, ...d });
            });

            // Sort: due date first (earliest), then newest createdAt
            items.sort((a, b) => {
              const ad = a.dueDate?.toDate ? a.dueDate.toDate() : (a.dueDate instanceof Date ? a.dueDate : null);
              const bd = b.dueDate?.toDate ? b.dueDate.toDate() : (b.dueDate instanceof Date ? b.dueDate : null);
              if (ad && bd) return ad - bd;
              if (ad && !bd) return -1;
              if (!ad && bd) return 1;
              const ac = a.createdAt?.toDate ? a.createdAt.toDate() : 0;
              const bc = b.createdAt?.toDate ? b.createdAt.toDate() : 0;
              return (bc || 0) - (ac || 0);
            });

            renderTasks(items);
          }, (err) => {
            console.warn('tasks listener error:', err);
            const el = document.getElementById('tasks-list');
            if (el) el.innerHTML = '<p style="color:#b91c1c">Failed to load tasks.</p>';
          });
      };

      firebase.auth().onAuthStateChanged((u) => {
        if (u) window.startTasksListener(u.uid);
      });
    })();
  </script>
</body>
</html>
