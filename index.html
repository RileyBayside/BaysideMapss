<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bayside — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logo.png" type="image/png" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24; --focus:#e6f0ff;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 22px; background:#fff; border-bottom:1px solid var(--muted); position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:14px }
    .brand img{ height:56px; display:block }
    .title{ font-size:22px; font-weight:800; color:var(--ink-2) }
    .userbox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .email{ font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0; padding:8px 10px; border-radius:10px; }
    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff; background:var(--ink); }
    .btn:hover{ background:#1f2937 }

    /* Page layout */
    .container{ max-width:1200px; margin: 20px auto; padding: 0 16px }

    /* Work-area cards */
    .areas{ display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px }
    .card{ background:var(--card); border:1px solid var(--muted); border-radius:16px; box-shadow:0 8px 26px rgba(16,24,40,.08); overflow:hidden }
    .card h4{ margin:0; padding:12px 16px; font-size:16px; font-weight:800 }
    .thumb{ position:relative; height:160px; background:#e5e7eb; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; filter:saturate(.8) contrast(.95) }
    .thumb .titleOverlay{
      position:absolute; left:16px; bottom:8px; color:#fff; font-weight:800; font-size:28px; text-shadow:0 2px 12px rgba(0,0,0,.6);
      letter-spacing:.5px;
    }
    .card .row{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px }
    .open{ background:var(--ink); color:#fff; border:0; border-radius:12px; padding:8px 14px; font-weight:800; cursor:pointer }
    .open:hover{ background:#1f2937 }

    /* Tasks to complete */
    .tasks{ margin-top:22px }
    .tasks h3{ margin:0 0 10px; font-size:18px; font-weight:800 }
    .task-group{ background:#fff; border:1px solid var(--muted); border-radius:16px; padding:14px 16px; margin:12px 0 }
    .task-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px }
    .group-name{ font-weight:800; font-size:16px; color:var(--ink-2) }
    .status{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; margin-left:8px; }
    .s-assigned{ background:#e0e7ff; color:#1e40af; border:1px solid #c7d2fe }
    .s-progress{ background:#fef3c7; color:#92400e; border:1px solid #fde68a }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      background:#f8fafc; border:1px solid #e2e8f0; color:#0f172a; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
    }
    .act-row{ display:flex; align-items:center; gap:10px }
    .btn-accent{ background:var(--accent) } .btn-accent:hover{ background:var(--accent-600) }
    .btn-ghost{ background:#0f172a; opacity:.85 } .btn-ghost:hover{ opacity:1 }

    .empty{ padding:18px; text-align:center; color:#64748b; border:1px dashed #cbd5e1; border-radius:16px; background:#fff }

    /* Small screens */
    @media (max-width:700px){
      .task-head{ flex-direction:column; align-items:flex-start }
      .act-row{ width:100% }
      .act-row .btn{ flex:1 }
    }
  </style>
</head>
<body>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside logo" onerror="this.style.display='none'">
      <div class="title">Dashboard</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">—</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">
    <section>
      <h3 style="margin:0 0 10px">Work areas</h3>
      <div class="areas">
        <article class="card">
          <div class="thumb"><img src="thumb-mowing.jpg" alt=""><div class="titleOverlay">MOWING</div></div>
          <div class="row">
            <h4>Parks Mowing</h4>
            <button class="open" onclick="location.href='ParksMowing.html'">Open</button>
          </div>
        </article>

        <article class="card">
          <div class="thumb"><img src="thumb-snipping.jpg" alt=""><div class="titleOverlay">SNIPPING</div></div>
          <div class="row">
            <h4>Parks Snipping</h4>
            <button class="open" onclick="location.href='ParksSnipping.html'">Open</button>
          </div>
        </article>

        <article class="card">
          <div class="thumb"><img src="thumb-firebreaks.jpg" alt=""><div class="titleOverlay">FIREBREAKS</div></div>
          <div class="row">
            <h4>Firebreaks</h4>
            <button class="open" onclick="location.href='Firebreaks.html'">Open</button>
          </div>
        </article>
      </div>
    </section>

    <section class="tasks">
      <h3>Tasks to complete</h3>
      <div id="tasksWrap" class="empty">Loading tasks…</div>
    </section>
  </main>

  <script>
    const db = firebase.firestore();

    // --- keep your logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await firebase.auth().signOut(); location.href = 'login.html'; }
      catch(e){ console.warn(e); }
    });

    /* ---------- ONLY NEW HELPER YOU ASKED FOR ---------- */
    async function setDisplayName(u) {
      const el = document.getElementById('userEmail');
      if (!el) return; // don’t break the rest of the page

      el.textContent = 'Signed in';
      try {
        const doc = await db.collection('users').doc(u.uid).get();
        const d = doc.data() || {};
        const display =
          d.name ||
          d.username ||
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;
        el.textContent = display;
      } catch (_) {
        el.textContent =
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;
      }
    }
    /* --------------------------------------------------- */

    // Renders the task groups
    function renderTasks(groups){
      const wrap = document.getElementById('tasksWrap');
      wrap.innerHTML = '';

      if (!groups.length){
        wrap.className = 'empty';
        wrap.textContent = 'No tasks yet. You’re all caught up!';
        return;
      }
      wrap.className = ''; // remove empty styles

      groups.forEach(g=>{
        const box = document.createElement('div');
        box.className = 'task-group';

        const head = document.createElement('div');
        head.className = 'task-head';

        const left = document.createElement('div');
        left.innerHTML = `<span class="group-name">${g.zone || 'Unzoned'}</span>` +
          (g.status === 'in_progress'
           ? ' <span class="status s-progress">In progress</span>'
           : ' <span class="status s-assigned">Assigned</span>');
        head.appendChild(left);

        const right = document.createElement('div');
        right.className = 'act-row';

        // Start / Mark done buttons
        if (g.status !== 'in_progress') {
          const start = document.createElement('button');
          start.className = 'btn btn-ghost';
          start.textContent = 'Start';
          start.onclick = ()=> updateAssignmentStatus(g.id, 'in_progress');
          right.appendChild(start);
        }
        const done = document.createElement('button');
        done.className = 'btn btn-accent';
        done.textContent = 'Mark done';
        done.onclick = ()=> updateAssignmentStatus(g.id, 'done');
        right.appendChild(done);

        head.appendChild(right);
        box.appendChild(head);

        const chips = document.createElement('div');
        chips.className = 'chips';
        (g.siteIds || []).forEach(id=>{
          const c = document.createElement('span');
          c.className='chip'; c.textContent = id;
          chips.appendChild(c);
        });
        box.appendChild(chips);

        wrap.appendChild(box);
      });
    }

    async function updateAssignmentStatus(id, status){
      try{
        const ref = db.collection('assignments').doc(id);
        const payload = { status, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
        if (status === 'done') payload.completedAt = firebase.firestore.FieldValue.serverTimestamp();
        await ref.update(payload);
      }catch(e){
        console.warn('update status error', e);
        alert('Failed to update task');
      }
    }

   <script>
  // Replace the whole function with this simpler version
  let unsubTasks = null;
  function startTasksListener(uid){
    if (unsubTasks) { try{unsubTasks();}catch(_){ } }

    // Simple query: only filter by userId, then filter/sort in JS
    unsubTasks = firebase.firestore().collection('assignments')
      .where('userId','==', uid)
      .onSnapshot(snap=>{
        const rows = [];
        snap.forEach(d => {
          const x = d.data() || {};
          if (x.status === 'assigned' || x.status === 'in_progress') {
            rows.push({ id:d.id, ...x });
          }
        });

        // Sort newest first by createdAt (if missing, treat as 0)
        rows.sort((a,b)=>{
          const ta = a.createdAt?.toMillis?.() ?? 0;
          const tb = b.createdAt?.toMillis?.() ?? 0;
          return tb - ta;
        });

        renderTasks(rows);
      }, err=>{
        console.error('tasks subscribe error', err);
        const wrap = document.getElementById('tasksWrap');
        wrap.className = 'empty';
        wrap.textContent = 'Failed to load tasks';
      });
  }
</script>

    // Auth gate (unchanged behavior) — we just add setDisplayName(u)
    firebase.auth().onAuthStateChanged((u)=>{
      if (!u){ location.href = 'login.html'; return; }

      // ✅ New line you asked to add:
      setDisplayName(u);

      // Keep tasks loading as before
      startTasksListener(u.uid);
    });
  </script>
</body>
</html>
