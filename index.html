<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside — Dashboard</title>

  <!-- Type -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --ink-2:#111827;
      --muted:#e5e7eb;
      --bg:#f6f7fb;
      --card:#ffffff;
      --accent:#d11e2b;
      --accent-600:#b71a24;
      --focus:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* Header (roomier for bigger logo) */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:16px 22px; background:#fff; border-bottom:1px solid var(--muted);
      position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:14px; min-width:0; }
    .brand img{ height:56px; display:block }
    .brand .title{
      font-size:22px; font-weight:800; color:var(--ink-2); letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userbox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .email{
      font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0;
      padding:8px 10px; border-radius:10px; max-width:52vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .btn{
      border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff;
      background:var(--ink);
    }
    .btn:hover{ background:#1f2937 }

    /* Layout */
    .container{ max-width:1120px; margin: 24px auto; padding: 0 16px }
    .section-title{ font-size:18px; font-weight:800; margin: 10px 2px 12px; color:var(--ink-2) }

    .card{
      background:var(--card); border:1px solid var(--muted); border-radius:16px;
      box-shadow:0 8px 26px rgba(16,24,40,.08);
    }

    /* Admin tools */
    .admin-grid{ display:grid; grid-template-columns: 1fr; gap:16px }
    .tool{ padding:16px }

    .tool-row{
      display:grid; grid-template-columns: 220px 1fr auto; align-items:center; gap:12px;
      padding:10px 0; border-top:1px dashed #e2e8f0;
    }
    .tool-row:first-of-type{ border-top:none }
    .tool-label{ font-weight:800; color:var(--ink-2) }

    .tool input, .tool select{
      width:100%; padding:11px 12px; border-radius:10px; border:1px solid var(--muted);
      font-size:15px; background:#fff;
    }
    .tool input:focus, .tool select:focus{ outline:3px solid var(--focus); border-color:#94a3b8 }

    .delete-col{ display:flex; gap:10px; align-items:center }
    .delete-btn{
      background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer;
    }
    .delete-btn:hover{ background:var(--accent-600) }

    .hint{ color:#64748b; font-size:13px }

    /* Quick links */
    .links{ display:grid; grid-template-columns: repeat(3, 1fr); gap:16px }
    .link-card{ overflow:hidden; display:flex; flex-direction:column }
    .link-card img{
      width:100%;
      height:220px; object-fit:cover; object-position:center; display:block; background:#e2e8f0;
    }
    .link-body{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px }
    .link-title{ font-weight:800; font-size:16px; color:var(--ink-2) }
    .link-go{
      text-decoration:none; color:#fff; background:var(--ink); padding:9px 12px; border-radius:10px; font-weight:800;
    }
    .link-go:hover{ background:#1f2937 }

    /* Alerts */
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#111827; color:#fff; padding:12px 14px; border-radius:10px; font-weight:700;
      display:none; z-index:50; box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .toast.show{ display:block }

    /* Responsive */
    @media (max-width:980px){
      .links{ grid-template-columns: 1fr 1fr }
    }
    @media (max-width:640px){
      .links{ grid-template-columns: 1fr }
      .brand .title{ display:none }
      .tool-row{ grid-template-columns: 1fr; gap:6px }
      .delete-col{ justify-content:flex-start }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside logo" onerror="this.style.display='none'">
      <div class="title">Dashboard</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">—</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">
    <!-- Admin tools -->
    <h2 class="section-title">Admin tools</h2>
    <section class="admin-grid">
      <div class="card tool">
        <!-- Create Operator -->
        <div class="tool-row">
          <div class="tool-label">Create Operator</div>
          <input id="co_username" placeholder="e.g., riley" autocomplete="off" />
          <div class="hint">Press <b>Enter</b> to create</div>
        </div>

        <!-- Set Password -->
        <div class="tool-row">
          <div class="tool-label">Set Password</div>
          <input id="sp_payload" placeholder="username:newpassword" autocomplete="off" />
          <div class="hint">Format: <b>username:newpassword</b> then press <b>Enter</b></div>
        </div>

        <!-- Delete User -->
        <div class="tool-row">
          <div class="tool-label">Delete User</div>
          <div class="delete-col">
            <select id="du_select">
              <option value="" disabled selected>Loading users…</option>
            </select>
            <button class="delete-btn" id="du_btn" type="button">Delete</button>
          </div>
          <div class="hint">Select user then press <b>Delete</b></div>
        </div>
      </div>
    </section>

    <!-- Quick links -->
    <h2 class="section-title" style="margin-top:22px">Work areas</h2>
    <section class="links">
      <article class="card link-card">
        <img src="MOWING PICTURE.png" alt="Parks Mowing" onerror="this.style.display='none'">
        <div class="link-body">
          <div class="link-title">Parks Mowing</div>
          <a class="link-go" href="parksmowing.html">Open</a>
        </div>
      </article>

      <article class="card link-card">
        <img src="SNIPPING PICTURE.png" alt="Parks Snipping" onerror="this.style.display='none'">
        <div class="link-body">
          <div class="link-title">Parks Snipping</div>
          <a class="link-go" href="parkssnipping.html">Open</a>
        </div>
      </article>

      <article class="card link-card">
        <img src="FIREBREAKS PICTURE.png" alt="Firebreaks" onerror="this.style.display='none'">
        <div class="link-body">
          <div class="link-title">Firebreaks</div>
          <a class="link-go" href="firebreaks.html">Open</a>
        </div>
      </article>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>
  <script src="firebase-init.js"></script>

  <script>
    // helpers
    function toast(msg, ms=2200){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    (function(){
      const emailEl = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');
      const db = firebase.firestore();
      const fns = firebase.functions();

      // auth gate
      firebase.auth().onAuthStateChanged(user=>{
        if(!user){ window.location.href = 'login.html'; return; }
        emailEl.textContent = user.email || 'Signed in';
      });

      logoutBtn.addEventListener('click', async ()=>{
        try{ await firebase.auth().signOut(); window.location.href = 'login.html'; }
        catch(e){ toast('Logout failed'); console.warn(e); }
      });

      // --- Admin tools wire-up ---

      // Create operator (Enter to submit)
      const coInput = document.getElementById('co_username');
      coInput.addEventListener('keydown', async (e)=>{
        if(e.key !== 'Enter') return;
        const username = (coInput.value || '').trim().toLowerCase();
        if(!username){ toast('Enter a username'); return; }
        try{
          const callable = fns.httpsCallable('adminCreateOperator');
          await callable({ username }); // server should create username@bayside.local
          toast('Operator created: ' + username);
          coInput.value = '';
        }catch(err){
          console.warn(err);
          toast('Create failed: ' + (err.message || err.code || 'error'));
        }
      });

      // Set password (username:newpassword)
      const spInput = document.getElementById('sp_payload');
      spInput.addEventListener('keydown', async (e)=>{
        if(e.key !== 'Enter') return;
        const payload = (spInput.value || '').trim();
        const idx = payload.indexOf(':');
        if(idx < 1 || idx === payload.length-1){
          toast('Use format username:newpassword'); return;
        }
        const username = payload.slice(0, idx).trim().toLowerCase();
        const password = payload.slice(idx+1).trim();
        if(password.length < 6){ toast('Password must be at least 6 chars'); return; }

        try{
          const callable = fns.httpsCallable('adminSetPassword');
          await callable({ username, password });
          toast('Password updated for ' + username);
          spInput.value = '';
        }catch(err){
          console.warn(err);
          toast('Set password failed: ' + (err.message || err.code || 'error'));
        }
      });

      // Populate delete dropdown from Firestore /users
      const duSelect = document.getElementById('du_select');
      const duBtn = document.getElementById('du_btn');

      function renderUserOption(doc){
        const data = doc.data() || {};
        const label = data.name ? `${data.name} (${data.email || '—'})` : (data.email || doc.id);
        const opt = document.createElement('option');
        opt.value = doc.id;
        opt.textContent = label;
        return opt;
      }

      db.collection('users').orderBy('name','asc').onSnapshot(snap=>{
        duSelect.innerHTML = '';
        if(snap.empty){
          const o = document.createElement('option');
          o.value=''; o.textContent='No users'; o.disabled = true; o.selected = true;
          duSelect.appendChild(o);
          return;
        }
        const ph = document.createElement('option');
        ph.value=''; ph.textContent='Select a user…'; ph.disabled = true; ph.selected = true;
        duSelect.appendChild(ph);

        snap.forEach(doc=> duSelect.appendChild(renderUserOption(doc)));
      }, err=>{
        console.warn(err);
        duSelect.innerHTML = '<option disabled selected>Error loading users</option>';
      });

      // Delete user (needs Cloud Function)
      duBtn.addEventListener('click', async ()=>{
        const uid = duSelect.value;
        if(!uid){ toast('Choose a user'); return; }
        if(!confirm('Delete this user? This cannot be undone.')) return;

        try{
          const callable = fns.httpsCallable('adminDeleteUser');
          await callable({ uid });
          toast('User deleted');
          duSelect.value = '';
        }catch(err){
          console.warn(err);
          toast('Delete failed: ' + (err.message || err.code || 'error'));
        }
      });
    })();
  </script>
</body>
</html>
