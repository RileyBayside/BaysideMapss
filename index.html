<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside – Dashboard</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">

  <!-- If you have an existing global style file, include it after this line -->
  <!-- <link rel="stylesheet" href="styles.css"> -->
</head>
<body>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>
  
  <!-- Header / App Bar -->
  <header class="appbar">
    <div class="appbar__left">
      <img class="logo" src="logo.png" alt="Bayside Slashing" />
      <h1 class="appbar__title">Dashboard</h1>
    </div>

    <div class="appbar__right">
      <span class="user-pill" id="user-email">user@bayside.local</span>
      <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">

<section class="section">
  
  <h2 class="section-title">Work areas</h2>

  <div class="cards-row">

    <!-- Parks Mowing -->
    <a href="./ParksMowing.html" class="work-card">
      <div class="work-card__img">
        <img src="MOWING PICTURE.png" alt="Parks Mowing map" />
      </div>
      <div class="work-card__footer">
        <span class="work-card__title">Parks Mowing</span>
        <span class="btn btn-dark">Open</span>
      </div>
    </a>

    <!-- Parks Snipping -->
    <a href="./ParksSnipping.html" class="work-card">
      <div class="work-card__img">
        <img src="SNIPPING PICTURE.png" alt="Parks Snipping map" />
      </div>
      <div class="work-card__footer">
        <span class="work-card__title">Parks Snipping</span>
        <span class="btn btn-dark">Open</span>
      </div>
    </a>

    <!-- Firebreaks -->
    <a href="./Firebreaks.html" class="work-card">
      <div class="work-card__img">
        <img src="FIREBREAKS PICTURE.png" alt="Firebreaks map" />
      </div>
      <div class="work-card__footer">
        <span class="work-card__title">Firebreaks</span>
        <span class="btn btn-dark">Open</span>
      </div>
    </a>

  </div>
</section>


    <!-- Tasks to complete -->
    <section class="section">
      <h2 class="section-title">Tasks to complete</h2>

      <!-- Your existing JS can inject items into this list -->
      <div id="tasks-list" class="tasks">
        <!-- Example task markup for reference (leave commented out)
        <div class="task">
          <div class="task__left">
            <div class="task__title">Zone 1 — Numbers 1–50</div>
            <div class="task__meta">Assigned · Due 15 Oct</div>
          </div>
          <div class="task__right">
            <span class="badge badge-amber">Assigned</span>
          </div>
        </div>
        -->
      </div>
    </section>

  </main>

  <footer class="footer-space"></footer>

<script>
  (function () {
    // Show a nice display name in the pill (top-right)
    async function setDisplayName(u) {
      const el = document.getElementById('user-email');
      if (!el) return;

      // default while we look it up
      el.textContent = 'Signed in';

      try {
        // try Firestore users/{uid} first
        const snap = await firebase.firestore().collection('users').doc(u.uid).get();
        const d = snap.data() || {};
        const display =
          d.name ||
          d.username ||
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;

        el.textContent = display;
      } catch (e) {
        // graceful fallback
        el.textContent =
          u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email ||
          u.uid;
      }
    }

    // When auth state is ready, update the pill (auth-guard handles redirects)
    firebase.auth().onAuthStateChanged((u) => {
      if (u) setDisplayName(u);
    });

    // Reusable logout (keeps your earlier fix)
    window.logout = async function () {
      try {
        await firebase.auth().signOut();
      } catch (e) {
        console.warn('signOut failed (will still redirect):', e);
      }
      try {
        sessionStorage.removeItem('bayside_next');
        localStorage.removeItem('bayside_next');
      } catch (_) {}
      location.replace('./login.html');
    };

    // Wire the button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => window.logout());
    }
  })();
</script>
  
<script>
  // ---- Tasks for the signed-in operator ----
  (function () {
    const db = firebase.firestore();

    // Renders the list into #tasks-list
    function renderTasks(items) {
      const el = document.getElementById('tasks-list');
      if (!el) return;

      el.innerHTML = '';
      if (!items.length) {
        const p = document.createElement('p');
        p.style.color = '#64748b';
        p.textContent = 'No tasks assigned yet.';
        el.appendChild(p);
        return;
      }

      items.forEach(t => {
        const row = document.createElement('div');
        row.className = 'task';

        const left = document.createElement('div');
        left.className = 'task__left';

        const title = document.createElement('div');
        title.className = 'task__title';
        // Example title: "Thorneside — M0123, M0361"
        const ids = Array.isArray(t.siteIds) && t.siteIds.length ? (' — ' + t.siteIds.join(', ')) : '';
        title.textContent = (t.zone || 'Task') + ids;

        const meta = document.createElement('div');
        meta.className = 'task__meta';
        // Show due date if present
        const due = (() => {
          const d = t.dueDate;
          // Handle Firestore Timestamp or JS Date
          const dt = d?.toDate ? d.toDate() : (d instanceof Date ? d : null);
          return dt ? dt.toLocaleDateString() : null;
        })();
        meta.textContent = due ? `Due ${due}` : 'Assigned';

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement('div');
        right.className = 'task__right';
        const badge = document.createElement('span');
        badge.className = 'badge badge-amber';
        badge.textContent = (t.status || 'assigned').replace(/^\w/, s => s.toUpperCase());
        right.appendChild(badge);

        row.appendChild(left);
        row.appendChild(right);
        el.appendChild(row);
      });
    }

    // Start a live listener for the current user’s assignments
    window.startTasksListener = function (uid) {
      // Keep query simple to avoid composite-index prompts; filter status client-side
      return db.collection('assignments')
        .where('userId', '==', uid)
        .onSnapshot((snap) => {
          const items = [];
          snap.forEach(doc => {
            const d = doc.data() || {};
            // Hide completed items here; adjust if you want to show them
            const status = (d.status || 'assigned').toLowerCase();
            if (status === 'completed') return;
            items.push({ id: doc.id, ...d });
          });

          // Sort: due date first (earliest), then newest created
          items.sort((a, b) => {
            const ad = a.dueDate?.toDate ? a.dueDate.toDate() : (a.dueDate instanceof Date ? a.dueDate : null);
            const bd = b.dueDate?.toDate ? b.dueDate.toDate() : (b.dueDate instanceof Date ? b.dueDate : null);
            if (ad && bd) return ad - bd;
            if (ad && !bd) return -1;
            if (!ad && bd) return 1;
            const ac = a.createdAt?.toDate ? a.createdAt.toDate() : 0;
            const bc = b.createdAt?.toDate ? b.createdAt.toDate() : 0;
            return (bc || 0) - (ac || 0);
          });

          renderTasks(items);
        }, (err) => {
          console.warn('tasks listener error:', err);
          const el = document.getElementById('tasks-list');
          if (el) el.innerHTML = '<p style="color:#b91c1c">Failed to load tasks.</p>';
        });
    };

    // Hook into auth state (auth-guard already enforces login)
    firebase.auth().onAuthStateChanged((u) => {
      if (!u) return;
      // kick off the live feed for THIS operator
      window.startTasksListener(u.uid);
    });
  })();
</script>  
</body>
</html>
