<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Current Assignments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logo.png" type="image/png" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24; --soft:#f8fafc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }

    /* App bar */
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:12px 18px; background:#fff; border-bottom:1px solid var(--muted);
      position:sticky; top:0; z-index:5;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .brand img{ height:44px; display:block }
    .brand .title{ font-size:20px; font-weight:800; color:var(--ink-2) }
    .userbox{ display:flex; align-items:center; gap:10px }
    .email{ font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0; padding:6px 10px; border-radius:9px; }

    /* Layout */
    .container{ max-width:1120px; margin:22px auto; padding:0 16px }
    .section-title{ font-size:18px; font-weight:800; margin: 4px 2px 14px; color:var(--ink-2) }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px }
    @media (max-width:900px){ .grid{ grid-template-columns: 1fr } }

    .card{
      background:var(--card); border:1px solid var(--muted); border-radius:16px;
      box-shadow:0 8px 26px rgba(16,24,40,.08);
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .card h3{ margin:0; font-size:16px; font-weight:800 }
    .muted{ color:#475569; font-size:13px }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap }
    .btn{
      border:0; border-radius:10px; padding:9px 12px; font-weight:800; cursor:pointer; color:#fff;
      background:var(--ink);
    }
    .btn:hover{ background:#1f2937 }
    .btn-red{ background:var(--accent) }
    .btn-red:hover{ background:var(--accent-600) }
    .pill{ padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px; white-space:nowrap }

    .pill-gray{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0 }
    .pill-amber{ background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca }
    .pill-green{ background:#dcfce7; color:#065f46; border:1px solid #bbf7d0 }

    .kvs{ display:flex; flex-wrap:wrap; gap:8px; font-size:13px; color:#475569 }
    .kvs > div{ display:inline-flex; align-items:center; gap:6px; background:#f8fafc; border:1px solid #e2e8f0; padding:6px 8px; border-radius:10px }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(15,23,42,.38); display:none; align-items:center; justify-content:center; z-index:40;
    }
    .modal-backdrop.show{ display:flex }
    .modal{
      width:min(920px, 94vw); max-height:86vh; overflow:auto;
      background:#fff; border:1px solid var(--muted); border-radius:16px; box-shadow:0 12px 36px rgba(16,24,40,.20);
    }
    .modal header{
      position:sticky; top:0; background:#fff; border-bottom:1px solid #eef2f7;
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal header h3{ margin:0; font-size:16px; font-weight:800 }
    .modal header .close{ border:0; background:#f1f5f9; border:1px solid #e2e8f0; color:#111827; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer }
    .modal .body{ padding:14px 16px; }
    .sites{ display:grid; gap:8px }
    .site-row{
      display:grid; grid-template-columns: 110px 1fr auto; align-items:center; gap:10px;
      padding:10px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;
    }
    @media (max-width:680px){
      .site-row{ grid-template-columns: 90px 1fr }
      .site-row .right{ grid-column: 1 / -1 }
    }
    .note{
      font-size:13px; color:#334155; background:#f8fafc; border:1px solid #e2e8f0; border-left:3px solid var(--accent);
      border-radius:8px; padding:8px 10px; white-space:pre-wrap;
    }
    .sub{ color:#64748b; font-size:12px }
  </style>

  <!-- Tiny pills for the modal rows -->
  <style>
    .assign-site-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:8px;background:#fff}
    .assign-site-row .sid{font-weight:800}
    .assign-site-row .note{font-size:13px;color:#64748b;margin-top:4px}
    .pill.assigned{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d}
    .pill.in_progress{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
    .pill.completed{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
  </style>
</head>
<body>

  <!-- Firebase (+ guard) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside" onerror="this.style.display='none'">
      <div class="title">Current assignments</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">—</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">
    <h2 class="section-title">Live tasks</h2>
    <section id="assignments" class="grid"></section>
  </main>

  <!-- Modal -->
  <div id="detailsBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">Assignment details</h3>
        <div style="display:flex; align-items:center; gap:8px">
          <button id="downloadBtn" class="btn">Download report</button>
          <a id="openMapBtn" class="btn btn-red" href="#" target="_blank" rel="noopener">Open in map</a>
          <button class="close" id="closeModalBtn">Close</button>
        </div>
      </header>
      <div class="body">
        <div id="assignmentMeta" class="kvs" style="margin-bottom:10px"></div>
        <div id="sitesList" class="sites"></div>
      </div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  (function(){
    const db = firebase.firestore();

    /* ---------- header auth ---------- */
    const emailEl  = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    firebase.auth().onAuthStateChanged(u => {
      if(!u){ location.href = 'login.html'; return; }
      emailEl.textContent = u.email || 'Signed in';
    });
    logoutBtn.addEventListener('click', async () => {
      try { await firebase.auth().signOut(); } catch(_) {}
      location.replace('login.html');
    });

    /* ---------- helpers ---------- */
    const fmt = (ts) => {
      if(!ts) return '';
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
      return d ? d.toLocaleString() : '';
    };
    const badge = (status) => {
      const s = (status||'assigned').toLowerCase();
      const map = { assigned:'pill-amber', 'in_progress':'pill-gray', completed:'pill-green' };
      const txt = s.replace('_',' ');
      return `<span class="pill ${map[s]||'pill-gray'}">${txt.charAt(0).toUpperCase()+txt.slice(1)}</span>`;
    };
    const escapeHtml = (s) =>
      String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function getPerSiteForId(perSite, rawId){
      if (!perSite) return undefined;
      const idU = String(rawId).toUpperCase();
      const idL = idU.toLowerCase();
      const noM = idU.replace(/^M/, '');
      return perSite[idU] ?? perSite[idL] ?? perSite[noM];
    }

    async function loadParkNotes(siteIds){
      if(!siteIds || !siteIds.length) return {};
      const ids = Array.from(new Set(siteIds.map(s=>String(s).toUpperCase())));
      const byId = {};
      const chunk = 10;
      for(let i=0;i<ids.length;i+=chunk){
        const batch = ids.slice(i, i+chunk);
        const snap = await db.collection('parkNotes')
          .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
          .get();
        snap.forEach(doc => byId[doc.id.toUpperCase()] = (doc.data()||{}).note || '');
      }
      return byId;
    }

    /* ---------- latest logs helper (for details/PDF) ---------- */
    async function loadLatestWorkLogs(siteIds, assignment) {
      if (!siteIds || !siteIds.length) return {};
      const ids = Array.from(new Set(siteIds.map(s => String(s).toUpperCase())));
      const byId = {};
      const chunk = 10;

      const opUid = assignment?.userId || null;
      const startedAt = assignment?.startedAt || null;

      for (let i = 0; i < ids.length; i += chunk) {
        const batch = ids.slice(i, i + chunk);
        let q = db.collection('work_logs').where('siteId', 'in', batch);
        if (opUid) q = q.where('operatorUid', '==', opUid);
        if (startedAt) q = q.where('timestamp', '>=', startedAt);

        const snap = await q.get();
        snap.forEach(doc => {
          const w = doc.data() || {};
          const sid = String(w.siteId || '').toUpperCase();
          if (!sid) return;
          const t =
            (w.completedAt?.toMillis?.() ?? w.timestamp?.toMillis?.() ??
             w.createdAt?.toMillis?.() ?? 0);
          const prev = byId[sid];
          if (!prev || t > prev._t) {
            byId[sid] = {
              status: (w.status || 'completed').toLowerCase(),
              note: (w.note || '').trim(),
              completedAt: w.completedAt || w.timestamp || w.createdAt || null,
              _t: t
            };
          }
        });
      }
      return byId;
    }

    /* ---------- live completion pill (hybrid: logs + assignment doc) ---------- */
    const liveCounters = {}; // assignmentId -> teardown

    function attachLiveCompletionCounter(assignmentId, assignmentData, chipEl){
      if (!chipEl) return;
      if (liveCounters[assignmentId]) { try{ liveCounters[assignmentId](); }catch(_){} }

      let siteIds = (assignmentData.siteIds || []).map(s=>String(s).toUpperCase());
      let perSite = assignmentData.perSite || {};

      const latest = {}; // { [sid]: {status, _t} }

      function recompute(){
        let done = 0;
        for (const sid of siteIds){
          const ps = (getPerSiteForId(perSite, sid) || {});
          const st = (latest[sid]?.status || ps.status || '').toLowerCase();
          if (st === 'completed') done++;
        }
        chipEl.textContent = String(done);
      }

      // assignment doc listener (perSite updates)
      const unsubAssign = db.collection('assignments').doc(assignmentId).onSnapshot(s=>{
        const d = s.data() || {};
        const newSiteIds = (d.siteIds || []).map(x=>String(x).toUpperCase());
        const changed = newSiteIds.length !== siteIds.length || newSiteIds.some((v,i)=>v!==siteIds[i]);
        siteIds = newSiteIds;
        perSite = d.perSite || {};
        if (changed) { startLogListeners(); }
        recompute();
      }, err => console.warn('assignment watch error:', err));

      // work_logs listeners
      const logUnsubs = [];
      function startLogListeners(){
        while (logUnsubs.length){ try{ logUnsubs.pop()(); }catch(_){} }
        const uniq = Array.from(new Set(siteIds));
        const chunk = 10;
        for (let i=0;i<uniq.length;i+=chunk){
          const batch = uniq.slice(i,i+chunk);

          let q = db.collection('work_logs').where('siteId','in', batch);
          if (assignmentData?.userId)    q = q.where('operatorUid','==', assignmentData.userId);
          if (assignmentData?.startedAt) q = q.where('timestamp','>=', assignmentData.startedAt);

          const attach = (query) => query.onSnapshot(snap=>{
            snap.docChanges().forEach(ch=>{
              const w = ch.doc.data() || {};
              const sid = String(w.siteId || '').toUpperCase();
              if (!sid) return;
              const t = (w.completedAt?.toMillis?.() ?? w.timestamp?.toMillis?.() ?? w.createdAt?.toMillis?.() ?? 0);
              if (!latest[sid] || t > latest[sid]._t){
                latest[sid] = { status: (w.status || 'completed').toLowerCase(), _t: t };
              }
            });
            recompute();
          }, err=>{
            console.warn('live counter error (batch):', err?.message || err);
            if (err?.code === 'failed-precondition' || /index/i.test(err?.message||'')){
              const fallback = db.collection('work_logs').where('siteId','in', batch);
              const u2 = attach(fallback);
              logUnsubs.push(u2);
            }
          });

          const u = attach(q);
          logUnsubs.push(u);
        }
      }

      recompute();
      startLogListeners();

      liveCounters[assignmentId] = () => {
        try{ unsubAssign(); }catch(_){}
        while (logUnsubs.length){ try{ logUnsubs.pop()(); }catch(_){} }
      };
    }

    /* ---------- list (admin) ---------- */
    const listEl = document.getElementById('assignments');

    async function deleteAssignment(assignmentId, labelText){
      const label = labelText || 'this task';
      const first = confirm(`Delete assignment: ${label}?\n\nThis will remove the task and its per-site progress from Firestore.`);
      if (!first) return;
      const second = confirm('Are you sure? This action cannot be undone here.');
      if (!second) return;
      try{
        await db.collection('assignments').doc(assignmentId).delete();
        if (liveCounters[assignmentId]) { try{ liveCounters[assignmentId](); }catch(_){} delete liveCounters[assignmentId]; }
      }catch(e){
        alert('Failed to delete: ' + (e.message || e.code || e));
      }
    }

    function renderAssignmentCard(doc){
      const d = doc.data() || {};
      const siteIds = Array.isArray(d.siteIds) ? d.siteIds.map(s=>String(s).toUpperCase()) : [];
      const perSite = d.perSite || {};
      const total = siteIds.length;
      const baselineDone = siteIds.filter(id => (getPerSiteForId(perSite, id)?.status||'').toLowerCase()==='completed').length;

      const el = document.createElement('div');
      el.className = 'card';

      const title = document.createElement('h3');
      title.textContent = (d.userName || 'Operator') + (d.zone ? ` · ${d.zone}` : '');
      el.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'kvs';
      meta.innerHTML = `
        <div><strong><span class="js-done">${baselineDone}</span>/${total}</strong> completed</div>
        ${d.dueDate ? `<div>Due: ${fmt(d.dueDate).split(',')[0]}</div>` : ''}
        ${d.status ? `<div>Status: ${badge(d.status)}</div>` : ''}
      `;
      el.appendChild(meta);

      const row = document.createElement('div');
      row.className = 'row';

      const muted = document.createElement('div');
      muted.className = 'muted';
      muted.textContent = siteIds.length ? siteIds.join(', ') : '—';
      row.appendChild(muted);

      const openBtn = document.createElement('button');
      openBtn.className = 'btn btn-red';
      openBtn.textContent = 'View details';
      openBtn.addEventListener('click', () => openDetails(doc.id));
      row.appendChild(openBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.textContent = 'Delete task';
      delBtn.addEventListener('click', () => deleteAssignment(doc.id, title.textContent));
      row.appendChild(delBtn);

      el.appendChild(row);

      // Live updates for the "done" part of the chip (hybrid)
      const chipDone = meta.querySelector('.js-done');
      attachLiveCompletionCounter(doc.id, d, chipDone);

      return el;
    }

    db.collection('assignments').onSnapshot(snap => {
      listEl.innerHTML = '';
      if (snap.empty){
        const c = document.createElement('div');
        c.className = 'card';
        c.innerHTML = '<div class="muted">No assignments yet.</div>';
        listEl.appendChild(c);
        Object.keys(liveCounters).forEach(id => { try{ liveCounters[id](); }catch(_){} delete liveCounters[id]; });
        return;
      }
      const docs = [];
      const presentIds = new Set();
      snap.forEach(doc => { docs.push(doc); presentIds.add(doc.id); });

      docs.sort((a,b)=>{
        const ad = a.data().dueDate?.toDate?.() ?? 0;
        const bd = b.data().dueDate?.toDate?.() ?? 0;
        return ad - bd;
      });
      docs.forEach(doc => listEl.appendChild(renderAssignmentCard(doc)));

      Object.keys(liveCounters).forEach(id => {
        if (!presentIds.has(id)) { try{ liveCounters[id](); }catch(_){} delete liveCounters[id]; }
      });
    }, err => {
      listEl.innerHTML = `<div class="card"><div class="muted" style="color:#b91c1c">Failed to load assignments: ${err.message||err}</div></div>`;
    });

    /* ---------- modal (live) ---------- */
    const backdrop   = document.getElementById('detailsBackdrop');
    const closeBtn   = document.getElementById('closeModalBtn');
    const modalTitle = document.getElementById('modalTitle');
    const metaBox    = document.getElementById('assignmentMeta');
    const sitesBox   = document.getElementById('sitesList');
    const openMapBtn = document.getElementById('openMapBtn');
    const downloadBtn= document.getElementById('downloadBtn');

    // focus-handling
    let lastFocusEl = null;
    function showModal(){
      lastFocusEl = document.activeElement;
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden','false');
      closeBtn?.focus();
    }
    function hideModal(){
      if (lastFocusEl && typeof lastFocusEl.focus === 'function') { lastFocusEl.focus(); }
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }
    closeBtn.addEventListener('click', hideModal);
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) hideModal(); });

    let unsubscribeDetails = null;
    let latestDocData = null;

    async function openDetails(assignmentId){
      if (unsubscribeDetails) { try { unsubscribeDetails(); } catch(_) {} unsubscribeDetails = null; }

      const render = async (snap) => {
        if (!snap.exists) { alert('Assignment not found'); return; }
        const d = snap.data() || {};
        latestDocData = d;

        const siteIds = Array.isArray(d.siteIds) ? d.siteIds.map(s=>String(s).toUpperCase()) : [];
        const perSite = d.perSite || {};

        const latestLogs = await loadLatestWorkLogs(siteIds, d);

        modalTitle.textContent = `${d.userName || 'Operator'} — ${d.zone || 'Task'}`;

        const mergedCompleted = siteIds.filter(id => {
          const ps = getPerSiteForId(perSite, id) || {};
          const lg = latestLogs[id] || {};
          return ((ps.status || lg.status || '').toLowerCase() === 'completed');
        }).length;
        const total = siteIds.length;

        metaBox.innerHTML = `
          <div><strong>${mergedCompleted}/${total}</strong> completed</div>
          ${d.dueDate ? `<div>Due: ${fmt(d.dueDate).split(',')[0]}</div>` : ''}
          ${d.status ? `<div>Overall: ${badge(d.status)}</div>` : ''}
          ${d.startedAt ? `<div>Started: ${fmt(d.startedAt).split(',')[0]}</div>` : ''}
        `;

        const focusCsv = siteIds.join(',');
        openMapBtn.href = focusCsv
          ? `AssignedParks.html?focus=${encodeURIComponent(focusCsv)}&task=${encodeURIComponent(snap.id)}`
          : '#';
        // Persist task id for robustness
        openMapBtn.addEventListener('click', () => {
          try { localStorage.setItem('currentTaskId', snap.id); } catch(_) {}
        });

        const permNotes = await loadParkNotes(siteIds);

        sitesBox.innerHTML = '';
        siteIds.forEach(id => {
          const ps = getPerSiteForId(perSite, id) || {};
          const lg = latestLogs[id] || {};

          const status = (ps.status || lg.status || 'assigned').toLowerCase();
          const opNote = (ps.note ?? lg.note ?? '').trim();
          const completedAt = ps.completedAt || lg.completedAt || null;
          const perm = (permNotes[id] || '').trim();

          const row = document.createElement('div');
          row.className = 'site-row';

          const left = document.createElement('div');
          left.innerHTML = `<strong>${id}</strong><div class="sub">${badge(status)}</div>`;

          const mid = document.createElement('div');
          let notesHtml = '';
          if (opNote) notesHtml += `<div class="note" style="border-left-color:#2563eb">Operator: ${escapeHtml(opNote)}</div>`;
          if (perm)   notesHtml += `<div class="note">Permanent: ${escapeHtml(perm)}</div>`;
          if (!notesHtml) notesHtml = `<div class="sub">No notes</div>`;
          mid.innerHTML = notesHtml;

          const right = document.createElement('div');
          right.className = 'right sub';
          right.textContent = completedAt ? `Completed: ${fmt(completedAt).split(',')[0]}` : '';

          row.appendChild(left);
          row.appendChild(mid);
          row.appendChild(right);
          sitesBox.appendChild(row);
        });

        showModal();
      };

      unsubscribeDetails = db.collection('assignments').doc(assignmentId)
        .onSnapshot(render, err => alert('Failed to load details: ' + (err.message||err)));

      downloadBtn.onclick = () => downloadReport(assignmentId);
    }

    /* ---------- PDF report ---------- */
    async function downloadReport(assignmentId){
      try{
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) { alert('PDF library not loaded'); return; }

        let d = latestDocData;
        if (!d) {
          const snap = await db.collection('assignments').doc(assignmentId).get();
          if (!snap.exists) { alert('Assignment missing'); return; }
          d = snap.data() || {};
        }

        const siteIds = (d.siteIds || []).map(s => String(s).toUpperCase());
        const perSite = d.perSite || {};
        const latestLogs = await loadLatestWorkLogs(siteIds, d);

        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const marginL = 56, startY = 64, lineH = 18;

        const _fmt = (ts) => {
          if(!ts) return '';
          const dt = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
          return dt ? dt.toLocaleString() : '';
        };

        const total = siteIds.length;
        const completed = siteIds.filter(id => {
          const ps = getPerSiteForId(perSite, id) || {};
          const lg = latestLogs[id] || {};
          return ((ps.status || lg.status || '').toLowerCase() === 'completed');
        }).length;

        doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text(`${d.userName || 'Operator'} — ${d.zone || 'Task'}`, marginL, startY);
        doc.setFont('helvetica','normal'); doc.setFontSize(12);
        doc.text(
          `Overall: ${(d.status||'in_progress')}   •   Completed: ${completed}/${total}   •   Started: ${d.startedAt ? _fmt(d.startedAt).split(',')[0] : '-'}`,
          marginL, startY + 22
        );

        let y = startY + 48;
        const header = ['Site','Status','Completed','Operator note'];
        const widths = [100,110,100,280];

        doc.setFont('helvetica','bold');
        header.forEach((h,i)=> doc.text(h, marginL + widths.slice(0,i).reduce((a,b)=>a+b,0), y));
        doc.setLineWidth(0.6); doc.line(marginL, y+6, marginL + widths.reduce((a,b)=>a+b,0), y+6);
        y += 20;

        doc.setFont('helvetica','normal');
        for (const id of siteIds){
          const ps = getPerSiteForId(perSite, id) || {};
          const lg = latestLogs[id] || {};

          const status      = (ps.status || lg.status || 'assigned').toLowerCase();
          const completedAt = (ps.completedAt || lg.completedAt) ? _fmt(ps.completedAt || lg.completedAt).split(',')[0] : '-';
          const note        = (ps.note ?? lg.note ?? '').trim() || '-';

          const cols = [id, status, completedAt, note];
          cols.forEach((val,i) => {
            const x = marginL + widths.slice(0,i).reduce((a,b)=>a+b,0);
            doc.text(String(val), x, y, { maxWidth: widths[i]-6 });
          });
          y += lineH;
          if (y > 780) { doc.addPage(); y = 56; }
        }

        const filename = `${(d.userName || 'operator').toLowerCase().replace(/\s+/g,'-')}-${(d.zone||'task').toLowerCase().replace(/\s+/g,'-')}.pdf`;
        doc.save(filename);
      }catch(e){
        alert('Failed to generate report: ' + (e.message||e));
        console.error(e);
      }
    }

  })();
  </script>
</body>
</html>
