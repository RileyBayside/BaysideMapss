<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Parks Mowing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="logo.png" type="image/png">

  <!-- Firebase auth + guard (NEW: add these for protected page) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Core Styles -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Sidebar Styles -->
  <link rel="stylesheet" href="sidebar.css">

  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>

  <!-- Sidebar toggle button -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar container -->
  <div id="sidebar">
    <button id="toggle-all">Expand All</button>
    <div id="sidebar-content"></div>

    async function buildMapAndSidebar({ allowIds, focusIds }) {
  // load GeoJSON (same as today)
  const resp = await fetch('data.geojson');
  const gj = await resp.json();

  // Normalize an ID for each feature
  function getSiteId(f){
    const p = f.properties || {};
    return String(p.code || p.id || p.name || f.id || '').toUpperCase();
  }

  // Filter features if allowIds was provided
  const feats = (gj.features || []).filter(f => {
    if (!allowIds) return true;          // show all (normal mode)
    return allowIds.has(getSiteId(f));   // only my tasks
  });

  // Render feats to map (your existing Leaflet layer)
  // Render the sidebar list using feats + their IDs (only allowed ones)

  // If focusIds present, zoom to those; else fit to all feats
}


    <button onclick="adminLogin()">Admin Login</button>

    <div id="admin-tools" style="display:none">
      <button onclick="exportPDFCouncil()">PDF report for Council</button>
      <button onclick="exportPDFBayside()">PDF Report for Bayside</button>
      <button onclick="clearUserData()">Clear All User Data</button>
      <button onclick="showToday()">Show Completed Today</button>
    </div>
  </div>

// 1) Read URL
const params = new URLSearchParams(location.search);
const showMine = params.get('show') === 'mine';
const focusCsv = params.get('focus') || ''; // optional

// 2) Wait for auth
firebase.auth().onAuthStateChanged(async (u) => {
  if (!u) return; // auth-guard will redirect

  // If not 'mine', just build the full map as today
  if (!showMine) { return buildMapAndSidebar({ allowIds: null, focusIds: [] }); }

  // 3) Pull this operator’s assignments
  const db = firebase.firestore();
  const snap = await db.collection('assignments')
    .where('userId', '==', u.uid)
    .get(); // (filter 'completed' client-side if needed)

  const allow = new Set();
  snap.forEach(doc => {
    const d = doc.data() || {};
    (Array.isArray(d.siteIds) ? d.siteIds : []).forEach(id => allow.add(String(id).toUpperCase()));
  });

  // 4) Optional focus
  const focusIds = focusCsv
    .split(',').map(s => s.trim().toUpperCase()).filter(Boolean);

  // 5) Build map + sidebar with allow-list
  buildMapAndSidebar({ allowIds: allow, focusIds });
});
  
  <!-- Map container -->
  <div id="map"></div>

  <!-- Core Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>

  <!-- Sidebar Script -->
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>

