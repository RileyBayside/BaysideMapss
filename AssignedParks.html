<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Same stack as ParksMowing -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="sidebar.css" />

  <style>
    /* Keep your existing look; a couple of layout tweaks */
    #sidebar{
      left: 8px !important;
      right: auto;
      bottom: 8px;
      height: auto;
      max-height: calc(100vh - 16px);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      pointer-events: auto;
      transition: transform .25s ease;
      will-change: transform;
    }
    #sidebar-content{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 8px;
    }
    #sidebar.is-collapsed { transform: translateX(calc(-100% - 12px)); }

    /* Floating collapse button */
    #sbMiniToggle{
      position: fixed; width:36px; height:36px;
      border:0; border-radius:9999px;
      background:#d11e2b; color:#fff; font-weight:900; font-size:18px; line-height:36px;
      box-shadow:0 6px 18px rgba(0,0,0,.22); cursor:pointer; z-index:1002;
      display:inline-flex; align-items:center; justify-content:center;
    }

    /* 1., 2., 3., … */
    .ap-num{ font-weight:800; margin-right:6px; }

    @media (max-width:768px){
      #sidebar{ left: 6px !important; right: 6px; border-radius:12px; }
    }
  </style>
</head>
<body>

  <!-- Firebase + guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Sidebar toggle kept for your CSS/JS -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar (IDs must match your sidebar.js) -->
  <div id="sidebar">
    <button id="toggle-all">Expand All</button>
    <div id="sidebar-content"></div>

    <button onclick="adminLogin()">Admin Login</button>
    <div id="admin-tools" style="display:none">
      <button onclick="exportPDFCouncil()">PDF report for Council</button>
      <button onclick="exportPDFBayside()">PDF Report for Bayside</button>
      <button onclick="clearUserData()">Clear All User Data</button>
      <button onclick="showToday()">Show Completed Today</button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Core scripts (same order as ParksMowing) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ----------------- helpers ----------------- */
    function qs(sel, root=document){ return root.querySelector(sel); }
    function focusIdsFromQuery(){
      const q = new URLSearchParams(location.search).get('focus') || '';
      return q.split(',').map(s=>s.trim()).filter(Boolean).map(s=>s.toUpperCase());
    }

    /* ----------------- keep sidebar under search ----------------- */
    (function stickSidebarUnderSearch(){
      function findSearch(){
        return (
          qs('#site-search') || qs('.site-search') || qs('#searchBar') ||
          qs('.search-bar')  || qs('#searchSite')  || qs('#search') ||
          qs('input[placeholder="Search ID..."]')
        );
      }
      function apply(){
        const sb = qs('#sidebar'); if (!sb) return;
        let top = 8;
        const s = findSearch();
        if (s){ const r = s.getBoundingClientRect(); top = Math.max(6, Math.round(r.bottom)) + 6; }
        sb.style.position = 'fixed';
        sb.style.top = top + 'px';
        sb.style.maxHeight = `calc(100vh - ${top + 8}px)`;
      }
      const rerun = ()=>{ apply(); requestAnimationFrame(apply); };
      window.addEventListener('load', rerun);
      window.addEventListener('resize', apply);
      const mo = new MutationObserver(apply);
      mo.observe(document.body, { childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
    })();

    /* ----------------- mini collapse button ----------------- */
    (function miniToggle(){
      const sidebar = qs('#sidebar');
      if (!sidebar) return;
      let t = qs('#sbMiniToggle');
      if (!t){
        t = document.createElement('button');
        t.id = 'sbMiniToggle'; t.type = 'button';
        t.setAttribute('aria-expanded','true');
        t.textContent = '‹';
        document.body.appendChild(t);
      }
      const topPx = ()=> parseInt(sidebar.style.top || '8',10) || 8;
      const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));
      function position(){
        if (!t) return;
        if (sidebar.classList.contains('is-collapsed')){
          t.style.left = '8px';
        } else {
          const rect = sidebar.getBoundingClientRect();
          const left = clamp(rect.right + 8, 8, (innerWidth||360) - 44);
          t.style.left = left + 'px';
        }
        t.style.top = (topPx()+4) + 'px';
      }
      function setExpanded(expanded){
        sidebar.classList.toggle('is-collapsed', !expanded);
        t.setAttribute('aria-expanded', String(expanded));
        t.textContent = expanded ? '‹' : '›';
        position();
      }
      t.addEventListener('click', ()=>{
        setExpanded(sidebar.classList.contains('is-collapsed'));
      });
      addEventListener('load', position);
      addEventListener('resize', position);
      const mo = new MutationObserver(position);
      mo.observe(document.body, { attributes:true, childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
      position();
    })();

    /* ----------------- mark task in_progress if ?task= ----------------- */
    (function markTaskStarted(){
      const db = firebase.firestore();
      const taskId = new URLSearchParams(location.search).get('task') || '';
      if (!taskId) return;
      firebase.auth().onAuthStateChanged(async (u)=>{
        if (!u) return;
        try{
          await db.runTransaction(async tx=>{
            const ref = db.collection('assignments').doc(taskId);
            const snap = await tx.get(ref);
            if (!snap.exists) return;
            const d = snap.data() || {};
            if (d.userId !== u.uid) return;
            if (d.status !== 'in_progress' && d.status !== 'completed'){
              tx.update(ref, {
                status: 'in_progress',
                startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                startedBy: u.uid
              });
            } else {
              tx.update(ref, { lastOpenedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
        }catch(e){ console.warn('markTaskStarted:', e); }
      });
    })();

    /* ----------------- filter sidebar to ?focus= ----------------- */
    (function filterAssigned(){
      const ids = focusIdsFromQuery();
      if (!ids.length){ return; }              // no filter requested
      const wanted = new Set(ids);

      const root = qs('#sidebar-content');
      if (!root) return;

      function rowId(el){
        const ds = el.dataset || {};
        let id = (ds.siteId || ds.siteid || ds.site || ds.id || ds.code || ds.sitecode || '').toUpperCase();
        if (!/^M\d{3,4}$/.test(id)){
          const m = (el.textContent||'').toUpperCase().match(/\bM\d{3,4}\b/);
          if (m) id = m[0];
        }
        return /^M\d{3,4}$/.test(id) ? id : '';
      }

      function siteRows(){
        const nodes = root.querySelectorAll(
          '[data-site-id],[data-siteid],[data-id],[data-site],[data-code],[data-sitecode],'+
          'li,.site-row,.site-item,.sidebar-row,.list-item,.item'
        );
        const out=[];
        nodes.forEach(el=>{
          if (el.closest('summary')) return;
          const id = rowId(el);
          if (id) out.push({el,id});
        });
        return out;
      }

      function numberRows(visible){
        visible.forEach(r=>{ const x=r.querySelector('.ap-num'); if (x) x.remove(); });
        let n=1;
        visible.forEach(row=>{
          const host = row.firstElementChild || row;
          const span = document.createElement('span');
          span.className='ap-num'; span.textContent = `${n++}.`;
          host.insertBefore(span, host.firstChild);
        });
      }

      function hideEmptyZones(){
        root.querySelectorAll('details,.zone,.zone-group').forEach(g=>{
          const any = [...g.querySelectorAll('li,.site-row,.site-item,.sidebar-row,.list-item,.item')]
            .some(el=> el.style.display !== 'none');
          g.style.display = any ? '' : 'none';
          if (any && 'open' in g) g.open = true;
        });
      }

      function banner(text){
        let b = qs('#assigned-filter-banner');
        if (!b){
          b = document.createElement('div');
          b.id='assigned-filter-banner';
          b.style.cssText='margin:10px;padding:10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff8f8;color:#7f1d1d;font-weight:700;';
          root.prepend(b);
        }
        b.textContent = text;
      }
      function clearBanner(){ const b=qs('#assigned-filter-banner'); if (b) b.remove(); }

      // retry loop: try up to 40 times (~4s) until sidebar items exist
      let tries = 0;
      (function tick(){
        tries++;
        const rows = siteRows();

        if (!rows.length){
          banner('Loading sites…');
          if (tries < 40) return setTimeout(tick, 100);
          // Give up quietly if nothing ever appeared
          clearBanner();
          return;
        }

        // We have rows – apply filter
        const visible=[];
        rows.forEach(({el,id})=>{
          const keep = wanted.has(id);
          el.style.display = keep ? '' : 'none';
          if (keep) visible.push(el);
        });

        if (!visible.length){
          banner('No assigned sites to show.');
        }else{
          clearBanner();
          numberRows(visible);
          hideEmptyZones();
        }
      })();
    })();
  </script>
</body>
</html>
