<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Same stack as ParksMowing -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="sidebar.css" />

  <style>
    /* Keep sidebar look; only additive tweaks here */
    #sidebar {
      left: 8px !important;
      right: auto;
      bottom: 8px;
      height: auto;
      max-height: calc(100vh - 16px);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      pointer-events: auto;
      transition: transform .25s ease;
      will-change: transform;
    }
    #sidebar-content{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 8px;
    }
    /* Mini ordinal before each visible site row */
    .ap-num{ font-weight:800; margin-right:6px; }

    /* Collapsible behaviour + floating toggle */
    #sidebar.is-collapsed { transform: translateX(calc(-100% - 12px)); }
    #sbMiniToggle{
      position: fixed; width:36px; height:36px; border:0; border-radius:9999px;
      background:#d11e2b; color:#fff; font-weight:900; font-size:18px; line-height:36px;
      box-shadow:0 6px 18px rgba(0,0,0,.22); cursor:pointer; z-index:1002;
      display:inline-flex; align-items:center; justify-content:center;
    }
    #sbMiniToggle:focus-visible{ outline:3px solid rgba(209,30,43,.35); outline-offset:2px; }

    @media (max-width:768px){
      #sidebar{ left: 6px !important; right: 6px; border-radius:12px; }
    }
  </style>
</head>
<body>

  <!-- Firebase + guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Sidebar toggle (same control id you already use) -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar (keep ids/classes so sidebar.css applies) -->
  <div id="sidebar">
    <button id="toggle-all">Expand All</button>
    <div id="sidebar-content"></div>

    <button onclick="adminLogin()">Admin Login</button>
    <div id="admin-tools" style="display:none">
      <button onclick="exportPDFCouncil()">PDF report for Council</button>
      <button onclick="exportPDFBayside()">PDF Report for Bayside</button>
      <button onclick="clearUserData()">Clear All User Data</button>
      <button onclick="showToday()">Show Completed Today</button>
    </div>
  </div>

  <!-- Map (created by your existing script.js) -->
  <div id="map"></div>

  <!-- Core scripts (exactly like ParksMowing order) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // -------- Helpers --------
    function getFocusIds(){
      const q = new URLSearchParams(location.search).get('focus') || '';
      return q.split(',').map(s=>s.trim()).filter(Boolean).map(s=>s.toUpperCase());
    }

    function whenSidebarReady(cb){
      const root = document.getElementById('sidebar-content');
      if (!root) return;
      if (root.children.length > 0) { cb(root); return; }
      const obs = new MutationObserver(()=>{
        if (root.children.length > 0){ obs.disconnect(); cb(root); }
      });
      obs.observe(root, { childList:true, subtree:true });
      setTimeout(()=>obs.disconnect(), 10000);
    }

    function extractId(el){
      const txt = (el.textContent || '').toUpperCase();
      const m = txt.match(/\bM\d{4}\b/);
      return m ? m[0] : null;
    }

    function addOrdinalNumbers(visibleRows){
      visibleRows.forEach(r=>{ const x=r.querySelector('.ap-num'); if (x) x.remove(); });
      let n=1;
      visibleRows.forEach(row=>{
        const host = row.firstElementChild || row;
        const span = document.createElement('span');
        span.className = 'ap-num';
        span.textContent = `${n++}.`;
        host.insertBefore(span, host.firstChild);
      });
    }

    function hideEmptyZones(root){
      const groups = root.querySelectorAll('details, .zone, .zone-group');
      groups.forEach(g=>{
        const any = [...g.querySelectorAll('li, .list-item, .sidebar-row, .site-row, .item')]
          .some(el => el.style.display !== 'none');
        g.style.display = any ? '' : 'none';
        if (any && 'open' in g) g.open = true;
      });
    }

    function filterSidebarToIds(ids){
      const root = document.getElementById('sidebar-content');
      const wanted = new Set(ids.map(s=>s.toUpperCase()));

      const rows = [...root.querySelectorAll('li, .list-item, .sidebar-row, .site-row, .item')];
      const keepers = [];
      rows.forEach(row=>{
        if (row.closest('summary')) return;  // don’t treat group headers as sites
        const id = extractId(row);
        if (!id) return;
        const keep = wanted.has(id);
        row.style.display = keep ? '' : 'none';
        if (keep) keepers.push(row);
      });

      // Show a small note if nothing matched
      if (!keepers.length){
        let banner = document.getElementById('assigned-filter-banner');
        if (!banner){
          banner = document.createElement('div');
          banner.id = 'assigned-filter-banner';
          banner.style.cssText = 'margin:10px; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:#fff8f8; color:#7f1d1d; font-weight:700;';
          banner.textContent = 'No assigned sites to show.';
          root.prepend(banner);
        }
      } else {
        addOrdinalNumbers(keepers);
      }

      hideEmptyZones(root);
    }

    // Position the sidebar 6px below your “Search ID…” control
    (function positionSidebarBelowSearch(){
      function findSearch(){
        return (
          document.querySelector('#site-search') ||
          document.querySelector('.site-search') ||
          document.querySelector('#searchBar') ||
          document.querySelector('.search-bar') ||
          document.querySelector('#searchSite') ||
          document.querySelector('#search') ||
          document.querySelector('input[placeholder="Search ID..."]')
        );
      }
      function apply(){
        const sbEl = document.getElementById('sidebar');
        if (!sbEl) return;
        let topPx = 8;
        const search = findSearch();
        if (search){
          const r = search.getBoundingClientRect();
          topPx = Math.max(6, Math.round(r.bottom)) + 6;
        }
        sbEl.style.position = 'fixed';
        sbEl.style.top = topPx + 'px';
        sbEl.style.maxHeight = `calc(100vh - ${topPx + 8}px)`;
      }
      const rerun = ()=>{ apply(); setTimeout(apply, 0); };
      window.addEventListener('load', rerun);
      window.addEventListener('resize', apply);
      const mo = new MutationObserver(apply);
      mo.observe(document.body, { childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
    })();

    // Floating collapse toggle
    (function setupMiniToggle(){
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      let toggle = document.getElementById('sbMiniToggle');
      if (!toggle){
        toggle = document.createElement('button');
        toggle.id = 'sbMiniToggle';
        toggle.type = 'button';
        toggle.setAttribute('aria-expanded','true');
        toggle.textContent = '‹';
        document.body.appendChild(toggle);
      }
      function sidebarTop(){
        const t = parseInt(sidebar.style.top || '8', 10);
        return Number.isFinite(t) ? t : 8;
      }
      function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
      function position(){
        const top = sidebarTop();
        if (sidebar.classList.contains('is-collapsed')){
          toggle.style.left = '8px';
        } else {
          const rect = sidebar.getBoundingClientRect();
          const left = rect.right + 8;
          const maxLeft = (window.innerWidth || 360) - 44;
          toggle.style.left = clamp(left, 8, maxLeft) + 'px';
        }
        toggle.style.top = (top + 4) + 'px';
      }
      function setExpanded(expanded){
        sidebar.classList.toggle('is-collapsed', !expanded);
        toggle.setAttribute('aria-expanded', String(expanded));
        toggle.textContent = expanded ? '‹' : '›';
        position();
      }
      toggle.addEventListener('click', ()=>{
        const expanded = !sidebar.classList.contains('is-collapsed');
        setExpanded(!expanded);
      });
      window.addEventListener('load', position);
      window.addEventListener('resize', position);
      const mo = new MutationObserver(position);
      mo.observe(document.body, { attributes:true, childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
      position();
    })();

    // Mark task in_progress when page is opened via ?task=...
    (function trackTaskOpen(){
      const db = firebase.firestore();
      const taskId = new URLSearchParams(location.search).get('task') || '';
      if (!taskId) return;
      firebase.auth().onAuthStateChanged(async (u)=>{
        if (!u) return;
        try{
          await db.runTransaction(async (tx)=>{
            const ref = db.collection('assignments').doc(taskId);
            const snap = await tx.get(ref);
            if (!snap.exists) return;
            const d = snap.data() || {};
            if (d.userId !== u.uid) return;
            if (d.status !== 'in_progress' && d.status !== 'completed'){
              tx.update(ref, {
                status: 'in_progress',
                startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                startedBy: u.uid
              });
            } else {
              tx.update(ref, { lastOpenedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
        } catch(e){ console.warn('Failed to mark task started:', e); }
      });
    })();

    // Main: filter after sidebar is built by your existing code
    (function main(){
      const ids = getFocusIds();
      if (!ids.length) return; // nothing to filter
      firebase.auth().onAuthStateChanged(()=>{
        whenSidebarReady(()=> filterSidebarToIds(ids));
      });
    })();
  </script>
</body>
</html>
