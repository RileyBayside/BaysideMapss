<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Core styles (same as ParksMowing) -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Sidebar styles (same as ParksMowing) -->
  <link rel="stylesheet" href="sidebar.css" />

  <style>
    :root{
      --ink:#0f172a; --muted:#e5e7eb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24;
      --soft:#f8fafc; --soft-2:#f1f5f9;
      --chip:#f8fafc; --chip-border:#e2e8f0;
      --chip-text:#111827; --chip-done:#16a34a; /* green */
    }

    #map { height: 100vh; }

    /* Sidebar container – rounded, small margins; stays below search */
    #sidebar{
      position: fixed;
      width: 340px; max-width:86vw;
      background:#fff; border-right:1px solid var(--muted);
      box-shadow:0 8px 26px rgba(16,24,40,.08);
      border-radius:14px; overflow:hidden;
      display:flex; flex-direction:column;
      z-index:1000; pointer-events:auto;
      transition: transform .25s ease; will-change: transform;
    }
    #sidebar.is-collapsed { transform: translateX(calc(-100% - 12px)); }

    .sidebar-head{
      position: sticky; top:0; z-index: 5;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      color:#fff; font-weight:800;
      background: linear-gradient(90deg, var(--accent), #eb4550);
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .sidebar-head img{ height:24px; width:auto; display:block }
    .sidebar-head .title{ font-size:14px; letter-spacing:.3px }

    #toggle-all{
      display:block; width:calc(100% - 24px);
      margin:10px 12px 8px;
      background:var(--accent); color:#fff; font-weight:800;
      border:0; border-radius:10px; padding:8px 10px; cursor:pointer;
    }
    #toggle-all:hover{ background:var(--accent-600); }

    #sidebar-content{
      flex:1 1 auto; min-height:0; overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:8px 12px 16px;
    }

    /* ======= ASSIGNED VIEW (chips) ======= */
    #assigned-wrapper{
      border:1px solid var(--muted);
      border-radius:12px;
      background:#fff;
      padding:10px 10px 8px;
      margin-bottom:10px;
    }
    .zone-block{ margin-bottom:10px; }
    .zone-title{
      font-weight:800; color:#111827;
      padding:6px 4px 8px;
      border-bottom:1px dashed #e5e7eb;
      margin-bottom:8px;
    }
    .chip-list{
      display:flex; flex-wrap:wrap; gap:6px;
      padding:2px 0 6px;
    }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      background:var(--chip); border:1px solid var(--chip-border);
      color:var(--chip-text); font-weight:700; font-size:13px;
      user-select:none; cursor:pointer;
    }
    .chip.done{
      background:rgba(22,163,74,.08);
      border-color:rgba(22,163,74,.35);
      color:var(--chip-done);
    }

    /* Floating chevron (collapse/expand) */
    #sbMiniToggle{
      position: fixed; width:36px; height:36px;
      border:0; border-radius:9999px;
      background:var(--accent); color:#fff; font-weight:900; font-size:18px; line-height:36px;
      box-shadow:0 6px 18px rgba(0,0,0,.22);
      cursor:pointer; z-index:1002; display:inline-flex; align-items:center; justify-content:center;
    }

    /* Fallback/keyboard sidebar toggle button */
    #sidebar-toggle{
      position: fixed; top:12px; left:12px; z-index:1000;
      background:#d11e2b; color:#fff; border:0; border-radius:10px;
      padding:8px 10px; font-weight:800; box-shadow:0 6px 18px rgba(16,24,40,.18)
    }

    @media (max-width:768px){
      #sidebar{ width:100vw; max-width:none; }
    }
  </style>
</head>
<body>

  <!-- Firebase + auth guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Fallback toggle -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-head">
      <img src="logo.png" alt="Bayside" onerror="this.style.display='none'">
      <div class="title">Assigned Parks</div>
    </div>

    <button id="toggle-all">Expand All</button>

    <!-- Our assigned chips view will be injected here -->
    <div id="sidebar-content"></div>

    <div style="padding:10px 12px 16px">
      <button onclick="adminLogin()" class="chip" style="border-radius:10px">Admin Login</button>
      <div id="admin-tools" style="display:none; margin-top:8px; display:grid; gap:6px">
        <button onclick="exportPDFCouncil()" class="chip" style="border-radius:10px">PDF report for Council</button>
        <button onclick="exportPDFBayside()" class="chip" style="border-radius:10px">PDF Report for Bayside</button>
        <button onclick="clearUserData()" class="chip" style="border-radius:10px">Clear All User Data</button>
        <button onclick="showToday()" class="chip" style="border-radius:10px">Show Completed Today</button>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Core scripts shared with ParksMowing -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Position the sidebar just below the search box -->
  <script>
  (function () {
    function findSearchBar() {
      return (
        document.querySelector('#site-search') ||
        document.querySelector('.site-search') ||
        document.querySelector('#searchBar') ||
        document.querySelector('.search-bar') ||
        document.querySelector('#searchSite') ||
        document.querySelector('#search') ||
        document.querySelector('input[placeholder="Search ID..."]')
      );
    }
    function repositionSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      let topPx = 8;
      const sb = findSearchBar();
      if (sb) {
        const r = sb.getBoundingClientRect();
        topPx = Math.max(6, Math.round(r.bottom)) + 6;
      }
      sidebar.style.left = '8px';
      sidebar.style.top = topPx + 'px';
      sidebar.style.bottom = '8px';
      sidebar.style.height = 'auto';
      sidebar.style.maxHeight = `calc(100vh - ${topPx + 8}px)`;
      sidebar.style.overflow = 'hidden';
    }
    const rerun = () => { repositionSidebar(); setTimeout(repositionSidebar, 0); };
    window.addEventListener('load', rerun);
    window.addEventListener('resize', repositionSidebar);
    const mo = new MutationObserver(repositionSidebar);
    mo.observe(document.body, { childList: true, subtree: true });
    setTimeout(() => mo.disconnect(), 6000);
  })();
  </script>

  <!-- Collapse/expand mini toggle -->
  <script>
  (function () {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;

    let toggle = document.getElementById('sbMiniToggle');
    if (!toggle) {
      toggle = document.createElement('button');
      toggle.id = 'sbMiniToggle';
      toggle.type = 'button';
      toggle.setAttribute('aria-label', 'Collapse sidebar');
      toggle.setAttribute('aria-expanded', 'true');
      toggle.textContent = '‹';
      document.body.appendChild(toggle);
    }

    function sidebarTopPx() {
      const t = parseInt(sidebar.style.top || '8', 10);
      return Number.isFinite(t) ? t : 8;
    }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function positionToggle() {
      const top = sidebarTopPx();
      if (sidebar.classList.contains('is-collapsed')) {
        toggle.style.left = '8px';
      } else {
        const rect = sidebar.getBoundingClientRect();
        const left = rect.right + 8;
        const maxLeft = (window.innerWidth || 360) - 44;
        toggle.style.left = clamp(left, 8, maxLeft) + 'px';
      }
      toggle.style.top = (top + 4) + 'px';
    }

    function setExpanded(expanded) {
      sidebar.classList.toggle('is-collapsed', !expanded);
      toggle.setAttribute('aria-expanded', String(expanded));
      toggle.setAttribute('aria-label', expanded ? 'Collapse sidebar' : 'Expand sidebar');
      toggle.textContent = expanded ? '‹' : '›';
      positionToggle();
    }

    toggle.addEventListener('click', () => {
      const expanded = !sidebar.classList.contains('is-collapsed');
      setExpanded(!expanded);
    });

    window.addEventListener('load', positionToggle);
    window.addEventListener('resize', positionToggle);
    const mo = new MutationObserver(positionToggle);
    mo.observe(document.body, { attributes: true, childList: true, subtree: true });
    setTimeout(() => mo.disconnect(), 6000);
    positionToggle();
  })();
  </script>

  <!-- Focus (IDs) utilities -->
  <script>
  function getFocusFromQuery() {
    const q = new URLSearchParams(location.search).get('focus') || '';
    return q.split(',').map(s => s.trim()).filter(Boolean).map(s => s.toUpperCase());
  }
  async function getFocusFromFirestore() {
    try {
      const u = firebase.auth().currentUser;
      if (!u) return [];
      const snap = await firebase.firestore().collection('assignments')
        .where('userId', '==', u.uid).get();
      const set = new Set();
      snap.forEach(doc => {
        const d = doc.data() || {};
        (d.siteIds || []).forEach(id => set.add(String(id).toUpperCase()));
      });
      return Array.from(set);
    } catch (e) {
      console.warn('fallback focus load failed:', e);
      return [];
    }
  }
  function whenSidebarReady(cb) {
    const root = document.getElementById('sidebar-content');
    if (!root) return;
    if (root.children.length > 0) { cb(root); return; }
    const obs = new MutationObserver((muts, observer) => {
      if (root.children.length > 0) {
        observer.disconnect();
        cb(root);
      }
    });
    obs.observe(root, { childList: true, subtree: true });
    setTimeout(() => obs.disconnect(), 10000);
  }
  </script>

  <!-- Build “Assigned View” (Zone header line + wrapped chips), sorted ascending -->
  <script>
  (function () {
    const db = firebase.firestore();
    const params = new URLSearchParams(location.search);
    const assignmentId = params.get('task'); // needed for writes (chip click => completed)

    // Write only the single perSite dotted key (lazy fill)
    async function setSiteStatus(siteId, newStatus) {
      if (!assignmentId) return;
      const uid = firebase.auth().currentUser?.uid || null;
      const base = `perSite.${String(siteId).toUpperCase()}`;
      const data = {
        [`${base}.status`]: newStatus,
        [`${base}.updatedAt`]: firebase.firestore.FieldValue.serverTimestamp(),
        [`${base}.operatorUid`]: uid
      };
      if (newStatus === 'completed') {
        data[`${base}.completedAt`] = firebase.firestore.FieldValue.serverTimestamp();
      }
      await db.collection('assignments').doc(assignmentId).set(data, { merge: true });
    }

    // Extract numeric part for sorting (M0123 -> 123)
    const idNum = (id) => {
      const m = String(id).match(/\d+/);
      return m ? parseInt(m[0], 10) : Number.MAX_SAFE_INTEGER;
    };

    // Parse the original sidebar to map Zone -> [IDs]
    function parseZonesFromExisting(root) {
      const zoneMap = new Map(); // "Zone 1" -> Set(ids)
      const details = root.querySelectorAll('details');
      details.forEach(d => {
        const title = (d.querySelector('summary')?.textContent || '').trim();
        if (!/^zone\s+\d+/i.test(title)) return;
        const key = title.replace(/\s+/g,' ').trim(); // normalized "Zone X"
        const ids = new Set();
        // find anything ID-like under this zone section
        d.querySelectorAll('*').forEach(el => {
          const txt = (el.textContent || '').toUpperCase();
          const match = txt.match(/\bM\d{3,5}\b/g);
          if (match) match.forEach(id => ids.add(id));
        });
        if (ids.size) zoneMap.set(key, ids);
      });
      return zoneMap;
    }

    // Build our chips UI: only show zones that have any of the focused IDs
    function buildAssignedView(root, focusedIds, perSiteStatuses) {
      // Remove old wrapper if present
      document.getElementById('assigned-wrapper')?.remove();

      const zoneMap = parseZonesFromExisting(root);
      const wrapper = document.createElement('div');
      wrapper.id = 'assigned-wrapper';

      const wanted = new Set(focusedIds.map(s => s.toUpperCase()));

      // For each zone in original order
      zoneMap.forEach((idsSet, zoneName) => {
        const ids = [...idsSet].filter(id => wanted.has(id));
        if (!ids.length) return; // skip zones with no assigned parks

        // Sort numerically
        ids.sort((a,b) => idNum(a) - idNum(b));

        const block = document.createElement('div');
        block.className = 'zone-block';

        const title = document.createElement('div');
        title.className = 'zone-title';
        title.textContent = zoneName; // separate line
        block.appendChild(title);

        const list = document.createElement('div');
        list.className = 'chip-list';

        ids.forEach(id => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = id;
          chip.setAttribute('data-site-id', id);

          // initial style from perSite
          const status = (perSiteStatuses[id]?.status || 'assigned');
          if (status === 'completed') chip.classList.add('done');

          // click to mark completed
          chip.addEventListener('click', async () => {
            if (chip.classList.contains('done')) return; // already done
            try {
              await setSiteStatus(id, 'completed');
            } catch(e) { console.warn('status update failed', e); }
          });

          list.appendChild(chip);
        });

        block.appendChild(list);
        wrapper.appendChild(block);
      });

      // If nothing matched, show a small note
      if (!wrapper.children.length) {
        const empty = document.createElement('div');
        empty.className = 'chip';
        empty.style.borderRadius = '10px';
        empty.textContent = 'No assigned sites to show.';
        wrapper.appendChild(empty);
      }

      // Inject our view at the top; keep original content beneath
      const sc = document.getElementById('sidebar-content');
      sc.prepend(wrapper);
    }

    // Watch original sidebar populate, then build our view
    function init() {
      const sc = document.getElementById('sidebar-content');
      if (!sc) return;

      // Determine the focused IDs (query first, else Firestore)
      async function computeAndBuild(perSite = {}) {
        let ids = getFocusFromQuery();
        if (!ids.length) ids = await getFocusFromFirestore();
        if (!ids.length) {
          // still render empty block (nice message)
          buildAssignedView(sc, [], {});
          return;
        }
        buildAssignedView(sc, ids, perSite);
      }

      // 1) Wait for existing sidebar content to be present (so we can read zones)
      whenSidebarReady(async () => {
        // 2) Build now with no statuses (they’ll refresh below when snapshot arrives)
        await computeAndBuild({});

        // 3) If we have an assignmentId, reflect live perSite statuses (turn chips green)
        const params = new URLSearchParams(location.search);
        const assignmentId = params.get('task');
        if (assignmentId) {
          firebase.firestore().collection('assignments').doc(assignmentId)
            .onSnapshot(async (doc) => {
              const d = doc.data() || {};
              const perSite = d.perSite || {};
              await computeAndBuild(perSite); // rebuild to color chips accordingly
            });
        }
      });
    }

    firebase.auth().onAuthStateChanged(() => init());
  })();
  </script>

  <!-- Mark assignment started on open (if ?task=...) -->
  <script>
  (function () {
    const db = firebase.firestore();
    const params = new URLSearchParams(location.search);
    const taskId = params.get('task');
    if (!taskId) return;

    firebase.auth().onAuthStateChanged(async (u) => {
      if (!u) return;
      try {
        await db.runTransaction(async (tx) => {
          const ref = db.collection('assignments').doc(taskId);
          const snap = await tx.get(ref);
          if (!snap.exists) return;
          const d = snap.data() || {};
          if (d.userId !== u.uid) return;

          if (d.status !== 'in_progress' && d.status !== 'completed') {
            tx.update(ref, {
              status: 'in_progress',
              startedAt: firebase.firestore.FieldValue.serverTimestamp(),
              startedBy: u.uid
            });
          } else {
            tx.update(ref, { lastOpenedAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        });
      } catch (e) {
        console.warn('Failed to mark task started:', e);
      }
    });
  })();
  </script>

</body>
</html>
