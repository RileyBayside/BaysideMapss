<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logo.png" type="image/png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --ink:#0f172a; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24;
    }
    html,body{ height:100%; margin:0; background:var(--bg);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink); }

    /* Header */
    .appbar{
      position:sticky; top:0; z-index:10; background:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; border-bottom:1px solid var(--muted);
    }
    .brand{ display:flex; align-items:center; gap:10px }
    .brand img{ height:40px }
    .title{ font-weight:800; font-size:16px }

    .pill{ font-weight:700; background:#f1f5f9; border:1px solid #e2e8f0; padding:6px 10px; border-radius:10px; color:#334155 }
    .btn{ border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; color:#fff; background:var(--ink) }
    .btn:hover{ background:#1f2937 }

    /* Layout */
    #sidebar-toggle{
      position:absolute; left:10px; top:68px; z-index:1000;
      background:#fff; border:1px solid var(--muted); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700;
      box-shadow:0 6px 20px rgba(16,24,40,.12);
    }
    #sidebar{
      position:absolute; left:0; top:56px; bottom:0; width:320px; z-index:999;
      background:#fff; border-right:1px solid var(--muted);
      box-shadow:0 8px 26px rgba(16,24,40,.08);
      display:flex; flex-direction:column;
    }
    #sidebar header{
      padding:12px 14px; border-bottom:1px solid var(--muted); display:flex; align-items:center; gap:10px; font-weight:800;
    }
    #sidebar header .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); display:inline-block }
    #sidebar .controls{ padding:10px 12px; display:grid; gap:8px; border-bottom:1px solid var(--muted); }
    #search{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--muted); }
    #summary{ color:#64748b; font-size:12px }
    #list{ padding:10px 12px; overflow:auto }

    .site-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; margin-bottom:8px; cursor:pointer;
    }
    .site-row .id{ font-weight:800; color:#111827 }
    .site-row .name{ color:#64748b; font-size:12px; margin-left:6px }
    .badge{ border-radius:999px; padding:3px 8px; font-weight:800; font-size:12px; background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; }

    #map{ position:absolute; top:56px; right:0; bottom:0; left:320px }

    @media (max-width: 900px){
      #map{ left:0 }
      #sidebar{ width:88%; transform:translateX(-100%); transition:transform .2s ease }
      #sidebar.open{ transform:translateX(0) }
    }
  </style>
</head>
<body>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="appbar">
    <div class="brand">
      <img src="logo.png" alt="Bayside" onerror="this.style.display='none'">
      <div class="title">Assigned Parks</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span id="who" class="pill">Signed in</span>
      <button class="btn" id="backBtn" type="button" onclick="location.href='index.html'">Back</button>
    </div>
  </header>

  <!-- Sidebar + Map -->
  <button id="sidebar-toggle">☰</button>
  <aside id="sidebar">
    <header><span class="dot"></span> Your assignments</header>
    <div class="controls">
      <input id="search" placeholder="Search ID or name…">
      <div id="summary">Loading…</div>
    </div>
    <div id="list"></div>
  </aside>

  <div id="map"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    (async function () {
      // ---------- helpers ----------
      const qs = new URLSearchParams(location.search);
      const focusSet = new Set(
        (qs.get('focus') || '')
          .split(',')
          .map(s => s.trim().toUpperCase())
          .filter(Boolean)
      );

      const whoEl  = document.getElementById('who');
      const listEl = document.getElementById('list');
      const searchEl = document.getElementById('search');
      const summaryEl = document.getElementById('summary');
      const side = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      toggle.addEventListener('click', ()=> side.classList.toggle('open'));

      function normId(p){
        if (!p) return '';
        return String(p.code || p.id || p.NAME || p.name || '').toUpperCase();
      }

      function setWhoText(u, doc){
        const d = doc?.data?.() || {};
        const display =
          d.name || d.username || u.displayName ||
          (u.email ? u.email.split('@')[0] : '') ||
          u.email || u.uid;
        if (whoEl) whoEl.textContent = display;
      }

      function badge(text){
        const b = document.createElement('span');
        b.className = 'badge'; b.textContent = text;
        return b;
      }

      // ---------- auth ----------
      const user = await new Promise(res => {
        const unsub = firebase.auth().onAuthStateChanged(u => { unsub(); res(u); });
      });
      if (!user) return; // auth-guard will redirect

      // Optional pretty name
      try {
        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
        setWhoText(user, doc);
      } catch { setWhoText(user); }

      // ---------- load assignments ----------
      const db = firebase.firestore();
      let allowIds = [];
      try {
        const snap = await db.collection('assignments')
          .where('userId','==', user.uid)
          .get();

        const s = new Set();
        snap.forEach(d => {
          const a = d.data() || {};
          const status = String(a.status || 'assigned').toLowerCase();
          if (status === 'completed') return;
          (a.siteIds || []).forEach(id => s.add(String(id).toUpperCase()));
        });
        allowIds = Array.from(s);
      } catch (e) {
        console.warn('Failed to load assignments:', e);
        allowIds = [];
      }

      // ---------- load geojson & filter ----------
      let features = [];
      try {
        const resp = await fetch('data.geojson');  // ensure this path/name matches your repo
        const gj = await resp.json();
        const all = Array.isArray(gj.features) ? gj.features : [];
        const allowSet = new Set(allowIds);
        features = allowIds.length ? all.filter(f => allowSet.has(normId(f.properties))) : all;
      } catch (e) {
        console.error('Failed to load data.geojson:', e);
        summaryEl.textContent = 'Failed to load map data.';
        return;
      }

      // ---------- map ----------
      const map = L.map('map', { zoomControl:true, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

      const layer = L.geoJSON(features, {
        style: (f) => {
          const id = normId(f.properties);
          return focusSet.has(id)
            ? { color:'#b91c1c', weight:3, fillColor:'#ef4444', fillOpacity:0.35 }
            : { color:'#1d4ed8', weight:2, fillColor:'#60a5fa', fillOpacity:0.25 };
        }
      }).addTo(map);

      // fit bounds (prefer focused)
      const fb = L.latLngBounds([]);
      if (focusSet.size) {
        layer.eachLayer(l => {
          const id = normId(l.feature?.properties);
          if (focusSet.has(id)) {
            const b = l.getBounds?.();
            if (b) fb.extend(b);
          }
        });
      }
      if (fb.isValid()) map.fitBounds(fb.pad(0.08));
      else {
        const b = layer.getBounds?.();
        if (b?.isValid()) map.fitBounds(b.pad(0.08));
        else map.setView([-27.5,153.2], 11);
      }

      // index layer by id for fast zoom
      const byId = new Map();
      layer.eachLayer(l => {
        const id = normId(l.feature?.properties);
        if (id) byId.set(id, l);
      });

      // ---------- sidebar list ----------
      function renderList(filter=''){
        listEl.innerHTML = '';
        const q = (filter||'').trim().toLowerCase();

        const items = features.filter(f => {
          if (!q) return true;
          const p = f.properties || {};
          const id = normId(p).toLowerCase();
          const nm = String(p.name || p.NAME || '').toLowerCase();
          return id.includes(q) || nm.includes(q);
        });

        if (!items.length) {
          const p = document.createElement('p');
          p.style.color = '#64748b';
          p.textContent = allowIds.length ? 'No assigned sites match your search.' : 'No sites match your search.';
          listEl.appendChild(p);
          return;
        }

        items.forEach(f => {
          const p = f.properties || {};
          const id = normId(p);
          const name = p.name || p.NAME || '';

          const row = document.createElement('div');
          row.className = 'site-row';

          const left = document.createElement('div');
          left.innerHTML = `<span class="id">${id}</span>${name ? `<span class="name">— ${name}</span>` : ''}`;

          const right = document.createElement('div');
          right.appendChild(badge(focusSet.has(id) ? 'Focus' : 'Assigned'));

          row.appendChild(left);
          row.appendChild(right);

          row.addEventListener('click', () => {
            const l = byId.get(id);
            if (l) {
              const b = l.getBounds?.();
              if (b?.isValid()) map.fitBounds(b.pad(0.12));
              // visual nudge
              l.setStyle({ color:'#b91c1c', weight:3, fillColor:'#ef4444', fillOpacity:0.35 });
            }
            if (window.innerWidth < 900) side.classList.remove('open');
          });

          listEl.appendChild(row);
        });

        // summary
        if (summaryEl) {
          const assigned = allowIds.length ? `${items.length} of ${allowIds.length} assigned site${allowIds.length===1?'':'s'}` : `${items.length} site(s)`;
          const focusTxt = focusSet.size ? ` · ${focusSet.size} highlighted` : '';
          summaryEl.textContent = assigned + focusTxt;
        }
      }

      renderList('');
      searchEl.addEventListener('input', (e)=> renderList(e.target.value));
    })();
  </script>
</body>
</html>
