<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Same stack as ParksMowing -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="sidebar.css" />

  <style>
    /* Keep your look; only small, additive tweaks */
    #sidebar{
      left: 8px !important;
      right: auto;
      bottom: 8px;
      height: auto;
      max-height: calc(100vh - 16px);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      pointer-events: auto;
      transition: transform .25s ease;
      will-change: transform;
    }
    #sidebar-content{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 8px;
    }
    #sidebar.is-collapsed { transform: translateX(calc(-100% - 12px)); }

    /* Small floating collapse button (kept from previous version) */
    #sbMiniToggle{
      position: fixed; width:36px; height:36px;
      border:0; border-radius:9999px;
      background:#d11e2b; color:#fff; font-weight:900; font-size:18px; line-height:36px;
      box-shadow:0 6px 18px rgba(0,0,0,.22); cursor:pointer; z-index:1002;
      display:inline-flex; align-items:center; justify-content:center;
    }

    /* Ordinal before each visible site row */
    .ap-num{ font-weight:800; margin-right:6px; }

    @media (max-width:768px){
      #sidebar{ left: 6px !important; right: 6px; border-radius:12px; }
    }
  </style>
</head>
<body>

  <!-- Firebase + guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Sidebar toggle (id kept for your CSS/JS) -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar (ids/classes kept so sidebar.css + sidebar.js work) -->
  <div id="sidebar">
    <button id="toggle-all">Expand All</button>
    <div id="sidebar-content"></div>

    <button onclick="adminLogin()">Admin Login</button>
    <div id="admin-tools" style="display:none">
      <button onclick="exportPDFCouncil()">PDF report for Council</button>
      <button onclick="exportPDFBayside()">PDF Report for Bayside</button>
      <button onclick="clearUserData()">Clear All User Data</button>
      <button onclick="showToday()">Show Completed Today</button>
    </div>
  </div>

  <!-- Map (created by your existing script.js) -->
  <div id="map"></div>

  <!-- Core scripts (exact order) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ----------------- Query helpers ----------------- */
    function getFocusIds(){
      const q = new URLSearchParams(location.search).get('focus') || '';
      return q.split(',')
              .map(s => s.trim())
              .filter(Boolean)
              .map(s => s.toUpperCase());
    }

    /* ----------------- Keep the sidebar below the search control ----------------- */
    (function positionSidebarBelowSearch(){
      function findSearch(){
        return (
          document.querySelector('#site-search') ||
          document.querySelector('.site-search') ||
          document.querySelector('#searchBar') ||
          document.querySelector('.search-bar') ||
          document.querySelector('#searchSite') ||
          document.querySelector('#search') ||
          document.querySelector('input[placeholder="Search ID..."]')
        );
      }
      function apply(){
        const sbEl = document.getElementById('sidebar');
        if (!sbEl) return;
        let topPx = 8;
        const search = findSearch();
        if (search){
          const r = search.getBoundingClientRect();
          topPx = Math.max(6, Math.round(r.bottom)) + 6;
        }
        sbEl.style.position = 'fixed';
        sbEl.style.top = topPx + 'px';
        sbEl.style.maxHeight = `calc(100vh - ${topPx + 8}px)`;
      }
      const rerun = ()=>{ apply(); setTimeout(apply, 0); };
      window.addEventListener('load', rerun);
      window.addEventListener('resize', apply);
      const mo = new MutationObserver(apply);
      mo.observe(document.body, { childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
    })();

    /* ----------------- Floating collapse toggle ----------------- */
    (function setupMiniToggle(){
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      let toggle = document.getElementById('sbMiniToggle');
      if (!toggle){
        toggle = document.createElement('button');
        toggle.id = 'sbMiniToggle';
        toggle.type = 'button';
        toggle.setAttribute('aria-expanded','true');
        toggle.textContent = '‹';
        document.body.appendChild(toggle);
      }
      function sidebarTop(){
        const t = parseInt(sidebar.style.top || '8', 10);
        return Number.isFinite(t) ? t : 8;
      }
      function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
      function position(){
        const top = sidebarTop();
        if (sidebar.classList.contains('is-collapsed')){
          toggle.style.left = '8px';
        } else {
          const rect = sidebar.getBoundingClientRect();
          const left = rect.right + 8;
          const maxLeft = (window.innerWidth || 360) - 44;
          toggle.style.left = clamp(left, 8, maxLeft) + 'px';
        }
        toggle.style.top = (top + 4) + 'px';
      }
      function setExpanded(expanded){
        sidebar.classList.toggle('is-collapsed', !expanded);
        toggle.setAttribute('aria-expanded', String(expanded));
        toggle.textContent = expanded ? '‹' : '›';
        position();
      }
      toggle.addEventListener('click', ()=>{
        const expanded = !sidebar.classList.contains('is-collapsed');
        setExpanded(!expanded);
      });
      window.addEventListener('load', position);
      window.addEventListener('resize', position);
      const mo = new MutationObserver(position);
      mo.observe(document.body, { attributes:true, childList:true, subtree:true });
      setTimeout(()=>mo.disconnect(), 6000);
      position();
    })();

    /* ----------------- Mark task started (?task=) ----------------- */
    (function trackTaskOpen(){
      const db = firebase.firestore();
      const taskId = new URLSearchParams(location.search).get('task') || '';
      if (!taskId) return;
      firebase.auth().onAuthStateChanged(async (u)=>{
        if (!u) return;
        try{
          await db.runTransaction(async (tx)=>{
            const ref = db.collection('assignments').doc(taskId);
            const snap = await tx.get(ref);
            if (!snap.exists) return;
            const d = snap.data() || {};
            if (d.userId !== u.uid) return;
            if (d.status !== 'in_progress' && d.status !== 'completed'){
              tx.update(ref, {
                status: 'in_progress',
                startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                startedBy: u.uid
              });
            } else {
              tx.update(ref, { lastOpenedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
        } catch(e){ console.warn('Failed to mark task started:', e); }
      });
    })();

    /* ----------------- Robust row detection + live filtering ----------------- */
    (function main(){
      const focusIds = getFocusIds();                   // e.g. ["M0123","M0361",...]
      if (!focusIds.length){ console.debug('[AssignedParks] No focus ids'); return; }
      console.debug('[AssignedParks] focus ids:', focusIds);

      const wanted = new Set(focusIds);

      const root = document.getElementById('sidebar-content');
      if (!root) return;

      let everFoundAny = false;

      function extractIdFrom(el){
        // Prefer data-* attributes
        const ds = el.dataset || {};
        let id = (ds.siteId || ds.siteid || ds.site || ds.id || ds.code || ds.sitecode || '').toUpperCase();
        // Fallback: scan text
        if (!/^M\d{3,4}$/.test(id)){
          const t = (el.textContent || '').toUpperCase();
          const m = t.match(/\bM\d{3,4}\b/);
          if (m) id = m[0];
        }
        return /^M\d{3,4}$/.test(id) ? id : '';
      }

      function findRows(){
        // Avoid headers (<summary>) and pick common item containers
        const nodes = root.querySelectorAll(
          '[data-site-id], [data-siteid], [data-id], [data-site], [data-code], [data-sitecode], '+
          'li, .site-row, .site-item, .sidebar-row, .list-item, .item'
        );
        const rows = [];
        nodes.forEach(el=>{
          if (el.closest('summary')) return;         // ignore zone headers
          const id = extractIdFrom(el);
          if (id) rows.push({ el, id });
        });
        return rows;
      }

      function numberVisible(visible){
        visible.forEach(r => { const x = r.querySelector('.ap-num'); if (x) x.remove(); });
        let n = 1;
        visible.forEach(row=>{
          const host = row.firstElementChild || row;
          const span = document.createElement('span');
          span.className = 'ap-num';
          span.textContent = `${n++}.`;
          host.insertBefore(span, host.firstChild);
        });
      }

      function hideEmptyZones(){
        const groups = root.querySelectorAll('details, .zone, .zone-group');
        groups.forEach(g=>{
          const any = [...g.querySelectorAll('li, .site-row, .site-item, .sidebar-row, .list-item, .item')]
            .some(el => el.style.display !== 'none');
          g.style.display = any ? '' : 'none';
          if (any && 'open' in g) g.open = true;
        });
      }

      function ensureBanner(text){
        let banner = document.getElementById('assigned-filter-banner');
        if (!banner){
          banner = document.createElement('div');
          banner.id = 'assigned-filter-banner';
          banner.style.cssText =
            'margin:10px; padding:10px; border:1px solid #e2e8f0; ' +
            'border-radius:8px; background:#fff8f8; color:#7f1d1d; font-weight:700;';
          root.prepend(banner);
        }
        banner.textContent = text;
      }
      function removeBanner(){
        const b = document.getElementById('assigned-filter-banner');
        if (b) b.remove();
      }

      function applyFilter(){
        const rows = findRows();
        console.debug('[AssignedParks] rows seen:', rows.length);

        if (!rows.length){
          ensureBanner('Loading sites…');
          return; // don’t hide zones yet; they may still be filling
        }

        // We’ve seen at least one real row at some point
        everFoundAny = true;

        // Filter by wanted set
        const visible = [];
        rows.forEach(({el, id})=>{
          const keep = wanted.has(id);
          el.style.display = keep ? '' : 'none';
          if (keep) visible.push(el);
        });

        console.debug('[AssignedParks] matched rows:', visible.length);

        if (!visible.length){
          ensureBanner('No assigned sites to show.');
        } else {
          removeBanner();
          numberVisible(visible);
          hideEmptyZones();
        }
      }

      // Run now, and keep re-running while content mounts
      applyFilter();

      const obs = new MutationObserver(() => { applyFilter(); });
      obs.observe(root, { childList:true, subtree:true });

      // Stop observing after 30s to avoid running forever
      setTimeout(()=>obs.disconnect(), 30000);
    })();
  </script>
</body>
</html>
