<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Assigned Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Core styles (same as ParksMowing) -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Sidebar styles (same as ParksMowing) -->
  <link rel="stylesheet" href="sidebar.css" />

  <style>
    /* Full-height map like ParksMowing */
    #map { height: 100vh; }
  </style>
</head>
<body>

  <!-- Firebase + auth guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Sidebar toggle button -->
  <button id="sidebar-toggle">☰</button>

  <!-- Sidebar container (same structure; behavior handled by your JS) -->
  <div id="sidebar">
    <button id="toggle-all">Expand All</button>
    <div id="sidebar-content"></div>

    <button onclick="adminLogin()">Admin Login</button>

    <div id="admin-tools" style="display:none">
      <button onclick="exportPDFCouncil()">PDF report for Council</button>
      <button onclick="exportPDFBayside()">PDF Report for Bayside</button>
      <button onclick="clearUserData()">Clear All User Data</button>
      <button onclick="showToday()">Show Completed Today</button>
    </div>
  </div>

  <!-- Map container (Leaflet map is created by script.js the same way as ParksMowing) -->
  <div id="map"></div>

  <!-- Core scripts (exactly as ParksMowing so it uses the SAME satellite layer + data.geojson) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Filter the sidebar to only show assigned IDs -->
  <script>
  (function () {
    // Parse ?focus=M0123,M0361,... from URL
    function getFocusFromQuery() {
      const q = new URLSearchParams(location.search).get('focus') || '';
      return q.split(',').map(s => s.trim()).filter(Boolean).map(s => s.toUpperCase());
    }

    // Fallback: if no focus param, fetch assignments for the signed-in user and use their IDs
    async function getFocusFromFirestore() {
      try {
        const u = firebase.auth().currentUser;
        if (!u) return [];
        const snap = await firebase.firestore().collection('assignments')
          .where('userId', '==', u.uid)
          .get();
        const set = new Set();
        snap.forEach(doc => {
          const d = doc.data() || {};
          (d.siteIds || []).forEach(id => set.add(String(id).toUpperCase()));
        });
        return Array.from(set);
      } catch (e) {
        console.warn('fallback focus load failed:', e);
        return [];
      }
    }

    // Wait for #sidebar-content to be populated by your existing code (script.js/sidebar.js)
    function whenSidebarReady(cb) {
      const root = document.getElementById('sidebar-content');
      if (!root) return;
      if (root.children.length > 0) { cb(root); return; }
      const obs = new MutationObserver((muts, observer) => {
        if (root.children.length > 0) {
          observer.disconnect();
          cb(root);
        }
      });
      obs.observe(root, { childList: true, subtree: true });
      // safety timeout (10s)
      setTimeout(() => obs.disconnect(), 10000);
    }

    // Heuristic: hide any sidebar row that does not contain one of the wanted IDs in its text
    function filterSidebarToIds(root, ids) {
      const wanted = new Set(ids.map(s => s.toUpperCase()));
      // Add a banner so operators know they’re seeing a filtered view
      const bannerId = 'assigned-filter-banner';
      let banner = document.getElementById(bannerId);
      if (!banner) {
        banner = document.createElement('div');
        banner.id = bannerId;
        banner.style.cssText = 'padding:8px 10px;margin:6px 0;border:1px solid #e2e8f0;background:#fff8f8;color:#7f1d1d;border-radius:8px;font-weight:700';
        root.prepend(banner);
      }
      banner.textContent = ids.length ? `Showing ${ids.length} assigned site(s)` : 'No assigned sites to show.';

      // Helper
      const hasAnyId = (el) => {
        const txt = (el.textContent || '').toUpperCase();
        for (const id of wanted) if (txt.includes(id)) return true;
        return false;
      };

      // Hide non-matching leaf rows
      const candidates = root.querySelectorAll('li, .list-item, .site-row, .item, .sidebar-item, .sidebar-row, .task-row, div'); // broad to be resilient
      candidates.forEach(el => {
        // Skip the banner itself
        if (el.id === bannerId) return;

        // Keep containers that hold matching children visible
        const keep = hasAnyId(el) || [...el.querySelectorAll('*')].some(hasAnyId);
        el.style.display = keep ? '' : 'none';
      });

      // Open any <details> that contain matches; hide empty ones
      root.querySelectorAll('details').forEach(d => {
        const visibleChild = [...d.querySelectorAll('li, .list-item, .site-row, .item, .sidebar-item, .sidebar-row')]
          .some(el => el.style.display !== 'none');
        if (visibleChild) {
          d.style.display = '';
          d.open = true;
        } else {
          d.style.display = 'none';
        }
      });
    }

    // Main flow: get focus IDs (query or Firestore), then filter once sidebar is ready
    firebase.auth().onAuthStateChanged(async (u) => {
      // auth-guard handles redirects; if signed in we proceed
      let ids = getFocusFromQuery();
      if (!ids.length) {
        ids = await getFocusFromFirestore();
      }
      if (!ids.length) return; // nothing to filter

      whenSidebarReady((root) => filterSidebarToIds(root, ids));
    });
  })();
  </script>
</body>
</html>
