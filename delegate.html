<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside ‚Äî Delegate tasks</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24; --focus:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 22px; background:#fff; border-bottom:1px solid var(--muted); position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:14px }
    .brand img{ height:56px; display:block }
    .title{ font-size:22px; font-weight:800; color:var(--ink-2) }
    .userbox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .email{ font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0; padding:8px 10px; border-radius:10px; }
    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff; background:var(--ink); }
    .btn:hover{ background:#1f2937 }

    /* Layout */
    .container{ max-width:1200px; margin: 20px auto; padding: 0 16px }
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;  /* left grows, right fixed */
      gap:16px;
    }
    @media (max-width:1100px){ .grid{ grid-template-columns: 1fr } }

    .card{ background:var(--card); border:1px solid var(--muted); border-radius:16px; box-shadow:0 8px 26px rgba(16,24,40,.08); }
    .card h3{ margin:14px 16px 10px; font-size:16px; font-weight:800; color:var(--ink-2) }
    .card .body{ padding: 0 16px 16px }

    .row{ display:flex; gap:10px }
    .row > *{ flex:1 }

    .strong{ font-weight:800 }

    .half{ display:grid; gap:6px }
    .btn-accent{ background:var(--accent) }
    .btn-accent:hover{ background:var(--accent-600) }

    /* Assign Parks (left) */
    .inputish{
      flex: 1; padding: 10px 12px; border: 1px solid var(--muted);
      border-radius: 10px; font-size: 14px;
    }
    .muted-note{ color:#64748b; display:block; margin-top:10px }

    /* One-per-line suburb rows (when a suburb has no item list) */
    .suburb-list{ list-style:none; padding:0; margin:0; display:grid; grid-template-columns:1fr; gap:8px }
    .suburb-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--muted); border-radius:10px; background:#fff;
    }
    .suburb-row-left{ display:flex; align-items:center; gap:10px }
    .suburb-row label{ font-weight:700; color:var(--ink-2); cursor:pointer }
    .suburb-row .mini{ border:0; border-radius:8px; padding:6px 10px; font-weight:800; background:var(--accent); color:#fff; cursor:pointer }
    .suburb-row .mini:hover{ background:var(--accent-600) }

    /* Collapsible suburb with many items */
    .suburb-details{ border:1px solid var(--muted); border-radius:10px; background:#fff; }
    .suburb-details summary{
      list-style:none; cursor:pointer; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:700; color:var(--ink-2);
    }
    .suburb-details[open] summary{ border-bottom:1px solid var(--muted) }
    .summary-left{ display:flex; align-items:center; gap:10px }
    .summary-right{ display:flex; align-items:center; gap:8px; color:#334155; font-weight:700 }
    .summary-right label{ cursor:pointer }

    .suburb-sites{ margin:0; padding:10px 14px 12px 14px }
    .suburb-sites li{
      display:flex; align-items:center; gap:10px; margin:4px 0;
      color:#111827; font-weight:400; /* items not bold */
    }
    .site-label{ flex:1 }
    .note-btn{
      border:1px solid #cbd5e1; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; font-weight:700; cursor:pointer;
    }
    .note-btn.has-note{ border-color:#b91c1c; color:#b91c1c }
    .note-btn:hover{ background:#f8fafc }

    /* Assignment (right) */
    .assign-stack{ max-width:360px; margin:0 auto } /* center contents */
    .assign-stack input, .assign-stack select, .assign-stack button{ width:100% }
    .foot{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }
    .grow{ flex:1 }

    .basket{ display:grid; gap:8px; margin-top:6px; max-height:260px; overflow:auto; padding-right:6px }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;
      font-weight:700;
    }
    .item small{ font-weight:600; color:#64748b }
    .item .del{ border:0; border-radius:8px; padding:6px 8px; font-weight:800; background:#f43f5e; color:#fff; cursor:pointer }
    .item .del:hover{ background:#be123c }
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
      background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
    }

    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111827; color:#fff;
      padding:12px 14px; border-radius:10px; font-weight:700; box-shadow:0 10px 24px rgba(0,0,0,.25); display:none; z-index:50;
    }
    .toast.show{ display:block }

    /* Notes modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:60 }
    .modal.open{ display:flex }
    .modal-card{ width:min(640px, 92vw); background:#fff; border-radius:14px; border:1px solid var(--muted); box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .modal-card header{ padding:14px 16px; border-bottom:1px solid var(--muted); font-weight:800; display:flex; justify-content:space-between; align-items:center }
    .modal-card .m-body{ padding:14px 16px }
    .modal-card footer{ padding:12px 16px; border-top:1px solid var(--muted); display:flex; gap:10px; justify-content:flex-end }
    .modal-card textarea{ width:100%; min-height:160px; resize:vertical; padding:10px 12px; border:1px solid var(--muted); border-radius:10px; font:14px/1.4 Inter,system-ui,sans-serif }
    .btn-outline{ background:#fff; color:#111827; border:1px solid #cbd5e1 }

    /* ---------- Even-fill layout for the left card ---------- */
    .bs-assign-left{ display:flex; flex-direction:column; }
    .bs-assign-left .body{ display:flex; flex-direction:column; flex:1 1 auto; }
    /* Make the suburb list fill the remaining height and spread its children */
    .bs-assign-left #assignParksList{
      flex:1 1 auto;
      display:flex;                 /* override the default grid */
      flex-direction:column;
      justify-content:space-between;/* evenly spread rows */
      gap:0;                        /* space-between handles spacing */
      min-height: 360px;            /* keeps things tidy on tall screens */
    }
    /* Short screens: fall back to normal stacking with scroll */
    @media (max-height: 780px){
      .bs-assign-left #assignParksList{
        justify-content:flex-start;
        gap:8px;
        overflow:auto;
      }
    }
  </style>
</head>
<body>

  <!-- Firebase + guard -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside logo" onerror="this.style.display='none'">
      <div class="title">Delegate tasks</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">‚Äî</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="grid">
      <!-- Left: Assign Parks -->
      <section class="card bs-assign-left">
        <h3>Assign Parks</h3>
        <div class="body">
          <div class="row" style="margin-bottom:10px; gap:8px">
            <input id="suburbSearch" placeholder="Search suburbs‚Ä¶" class="inputish">
            <button id="addSelectedSuburbs" class="btn btn-accent" type="button">Add selected</button>
          </div>

          <ul id="assignParksList" class="suburb-list"></ul>

          <small class="muted-note">
            Ticking items on the left will appear as <b>Tasks</b> on the right. ‚ÄúAdd selected‚Äù also pushes your current ticks.
          </small>
        </div>
      </section>

      <!-- Right: Assignment -->
      <aside class="card">
        <h3>Assignment</h3>
        <div class="body">
          <div class="assign-stack">
            <div class="half">
              <label class="strong" for="operatorSel">Operator</label>
              <select id="operatorSel" required>
                <option disabled selected>Loading operators‚Ä¶</option>
              </select>
              <small style="color:#64748b">Pulls from <b>users</b> where <code>role == "operator"</code>.</small>
            </div>

            <div class="half">
              <label class="strong">Assign by site IDs</label>
              <input id="ids_input" placeholder="e.g. M0123, M0361" />
              <button class="btn btn-accent" id="ids_add" type="button">Assign</button>
            </div>

            <div class="half">
              <label>Notes (optional)</label>
              <input id="note_input" placeholder="e.g., High priority, access after 10am" />
            </div>

            <div class="half">
              <label>Due date (optional)</label>
              <input id="due_input" type="date" />
            </div>

            <div class="half">
              <label class="strong">Tasks</label>
              <div id="basket" class="basket"></div>
            </div>

            <div class="foot">
              <button class="btn grow" id="assignBtn" type="button">Assign tasks</button>
              <button class="btn" id="clearBtn" type="button" style="background:#64748b">Clear</button>

              <!-- NEW: view current assignments -->
              <div class="half" style="margin-top:6px; width:100%">
                <a class="btn btn-outline" href="assignments.html" style="text-align:center; display:block">View current assignments</a>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Notes Modal -->
  <div id="noteModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <header>
        <span id="noteModalTitle">Note</span>
        <button class="btn btn-outline" id="noteCloseBtn" type="button">Close</button>
      </header>
      <div class="m-body">
        <textarea id="noteTextarea" placeholder="Add a note for this park‚Ä¶"></textarea>
        <small id="noteHint" class="muted-note"></small>
      </div>
      <footer>
        <button class="btn btn-accent" id="noteSaveBtn" type="button">Save note</button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Tiny toast ----------
    function toast(msg, ms=2000){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    // ---------- Firebase handles ----------
    const db = firebase.firestore();
    let currentUser = null;
    let _operators = [];
    let _basket = [];                 // [{ zone, siteIds:[] }]
    let _isAdmin = false;

    const emailEl   = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const operatorSel = document.getElementById('operatorSel');
    const idsInput = document.getElementById('ids_input');
    const idsAdd   = document.getElementById('ids_add');
    const noteInput = document.getElementById('note_input');
    const dueInput  = document.getElementById('due_input');
    const basketEl  = document.getElementById('basket');
    const assignBtn = document.getElementById('assignBtn');
    const clearBtn  = document.getElementById('clearBtn');

    firebase.auth().onAuthStateChanged(async (u)=>{
      if(!u){ location.href = 'login.html'; return; }
      currentUser = u;
      emailEl.textContent = u.email || 'Signed in';

      // fetch role for admin gating
      try{
        const doc = await db.collection('users').doc(u.uid).get();
        _isAdmin = !!doc.exists && (doc.data().role === 'admin');
      }catch(_){ _isAdmin = false; }

      loadOperators();
    });

    logoutBtn.addEventListener('click', async ()=>{
      try{ await firebase.auth().signOut(); location.href = 'login.html'; }
      catch(e){ console.warn(e); toast('Logout failed'); }
    });

    function loadOperators(){
      const OP_DOMAIN = 'operators.bayside-maps.local';
      const labelFor = (u)=> u.username ? u.username :
        (u.email && u.email.endsWith('@'+OP_DOMAIN) ? u.email.replace('@'+OP_DOMAIN,'') : (u.email || 'unknown'));

      db.collection('users').where('role','==','operator').onSnapshot(
        (snap)=>{
          const ops=[]; snap.forEach(d=>ops.push({ uid:d.id, ...d.data() }));
          _operators = ops.slice();
          ops.sort((a,b)=> labelFor(a).localeCompare(labelFor(b)));
          operatorSel.innerHTML = '';
          if(!ops.length){ operatorSel.innerHTML = '<option disabled selected>No operators found</option>'; return; }
          const ph = document.createElement('option');
          ph.disabled = true; ph.selected = true; ph.textContent = 'Select operator‚Ä¶';
          operatorSel.appendChild(ph);
          for(const o of ops){
            const opt = document.createElement('option');
            opt.value = o.uid; opt.textContent = labelFor(o);
            operatorSel.appendChild(opt);
          }
        },
        (err)=>{ console.error(err); operatorSel.innerHTML = '<option disabled selected>Error loading operators</option>'; }
      );
    }

    // ---------- Tasks (basket) render ----------
    function renderBasket(){
      basketEl.innerHTML = '';
      if(_basket.length === 0){
        const p = document.createElement('p');
        p.style.color = '#64748b';
        p.textContent = 'No tasks yet. Tick parks on the left or paste site IDs.';
        basketEl.appendChild(p);
        return;
      }
      _basket.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'item';
        const left = document.createElement('div');
        left.innerHTML = `<span class="pill">${it.zone}</span> <small>‚Äî ${it.siteIds.join(', ')}</small>`;
        const del = document.createElement('button');
        del.className = 'del'; del.textContent = 'Remove';
        del.onclick = ()=>{ _basket.splice(idx,1); renderBasket(); };
        row.appendChild(left); row.appendChild(del);
        basketEl.appendChild(row);
      });
    }

    // ‚ÄúAssign by site IDs‚Äù
    idsAdd.addEventListener('click', ()=>{
      const raw = (idsInput.value||'').trim();
      if(!raw){ toast('Enter at least one site ID'); return; }
      const ids = raw.split(',').map(s=>s.trim()).filter(Boolean);
      _basket.push({ zone:'', siteIds: ids });
      renderBasket();
      idsInput.value='';
    });

    clearBtn.addEventListener('click', ()=>{
      _basket.length = 0;
      // also uncheck left side
      document.querySelectorAll('#assignParksList input[type="checkbox"]').forEach(cb=>cb.checked=false);
      renderBasket();
    });

    assignBtn.addEventListener('click', async ()=>{
      const uid = operatorSel.value;
      if(!uid){ toast('Choose an operator'); return; }
      if(_basket.length === 0){ toast('No tasks selected'); return; }

      try{
        const op = _operators.find(o=>o.uid===uid) || {};
        const batch = db.batch();
        const now = firebase.firestore.FieldValue.serverTimestamp();
        _basket.forEach(it=>{
          const ref = db.collection('assignments').doc();
          batch.set(ref, {
            userId: uid,
            userName: op.name || op.username || '',
            zone: it.zone || '',
            parksRange: '',            // kept for compatibility
            siteIds: it.siteIds || [],
            notes: (noteInput.value||''),
            dueDate: dueInput.value ? new Date(dueInput.value) : null,
            status: 'assigned',
            createdAt: now,
            createdBy: currentUser.uid
          });
        });
        await batch.commit();
        toast('Tasks assigned');
        _basket.length = 0; renderBasket();
        noteInput.value=''; dueInput.value='';
      }catch(err){
        console.warn(err);
        toast('Assign failed: ' + (err.message || err.code || 'error'));
      }
    });

    // ---------- Suburbs + Parks ----------
    const SUBURBS = [
      'Thorneside','Birkdale','Wellington Point','Alexandra Hills','Capalaba',
      'Ormiston','Cleveland','Thornlands','Victoria Point','Redland Bay','Mt Cotton'
    ];

    const SUBURB_ITEMS = {
      'Thorneside': [
        '1. M0123 - Helens Street','2. M0427 - Thorneside Road Foreshore Area',
        '3. M0402 - Queens Esplanade vacant block near No.48','4. M0136 - Leon St and Fisher Rd',
        '5. M0364 - Fisher Road to Mooroondu sportsfields','6. M0408 - Saul Street',
        '7. M0819 - Alma Street','8. M0105 - Alma Street','9. M0359 - Eva Street Pumphouse',
        '10. M0361 - Ferry Road','11. M0362 - Ferry Road - frontages to drainage areas',
        '12. M0363 - Ferry Road Council block near No. 86','13. M1677 - Ferry Road',
        '14. M0392 - Mond Street','15. M0436 - Wunulla Street','16. M0110 - Boorana Street',
        '17. M0147 - Railway Parade','18. M0367 - Frank and Beatty Streets','19. M0374 - Henry Street'
      ],
      'Birkdale': [
        '20. M0163 - Victor Street','21. M0140 - Mary Street','22. M1361 - Mary Street Scout Hall',
        '23. M0390 - Mary Street to Agnes Street','24. M0389 - Mary Pleasant Drive 1',
        '25. M0130 - John Goleby Canal','26. M0103 - Agnes Street','27. M0350 - Chart Street',
        '28. M0120 - Genrich Canal','29. M0114 - Clauson Canal Park','30. M0104 - Alan Woodgate Canal Park',
        '31. M0131 - Keel Street','32. M0388 - Mary Pleasant Drive','33. M0394 - Myra Street to Napier Street',
        '34. M0356 - Dorsal Drive - Wood Canal','35. M01360','36. M0358 - Estelle Street',
        '37. M0369 - Galley Way 2','38. M0133 - Laidlaw Canal Park','39. M0385 - Mako Avenue Grassed median strips',
        '40. M0370 - Galley Way Walkway','41. M0368 - Galley Way 1','42. M0432 - Wahoo Court inc median strip',
        '43. M0355 - Dorsal Drive','44. M0139 - MacGregor Drive','45. M0122 - Hardy, Badgen and Paul Street',
        '46. M0143 - Pandanus Street','47. M0111 - Bryce Place','48. M0157 - Sunnybay Drive',
        '49. M0424 - Sunnybay Drive to Spoonbill Street','50. M0165 - Wren Court Park',
        '51. M0815 - Wren Court to Parakeet Street','52. M0354 - Currawong Drive to Burbank Road/Parakeet Street',
        '53. M0875 - Patersonia Place','54. M0375 - Heston / Creswick Place','55. M0338 - Barron Road',
        '56. M0137 - Little Hyde Park','57. M0149 - Robinson Park','58. M0366 - Francene Place',
        '59. M0794 - Vedson Street Drainage reserve','60. M0113 - Carinyan Drive','61. M0118 - Fuchsia Close',
        '62. M0138 - Lobelia Street','63. M0380 - Leilani Drive - frontage to conservation area','64. M0398 - Palgold Court',
        '65. M0132 - Kensington Place','66. M0342 - Birkdale Fodder Forest','67. M0116 - Creek Road',
        '68. M0135 - Leicester Street','69. M0774 - Harrogate Easement','70. M0134 - Lanaglen Drive',
        '71. M0391 - Mecoli Court','72. M0405 - Remo Place','73. M0145 - Pedwell Place','74. M0112 - Byng Road Park',
        '75. M0146 - Pistachio Court Park','76. M1680 - 1-7 Quarry Road','77. M0337 - Ashwood Circuit to Quarry Road',
        '78. M0160 - Tulipwood Drive','79. M0334 - Amalia Street','80. M0352 - Clive Road to Whitehall Avenue',
        '81. M0154 - St James Park'
      ],
      'Wellington Point': [
        '82. M0412 - Sovereign Waters Estate','83. M0333 - Allan Day Drive (House 39)','84. M0809 - Helena Street Park',
        '85. M0386 - Marcel Place to Beachcrest Road','86. M0162 - Vantage Crescent',
        '87. M0343 - Birkdale Rd footpath - in front of unit complex','88. M0407 - Rye Street to Roberts Street',
        '89. M0127 - Jacob Street','90. M0119 - Galena Street','91. M0428 - Valley Road',
        '92. M0430 - Valley Road walkway extending into bushland','93. M0429 - Valley Road closed off area',
        '94. M1698 - Arbor Terrace, Wellington Point','95. M1507 - Station Street','96. M0109 - Bibury and Sawmill Street',
        '97. M0141 - Mindarie Crescent','98. M0820 - Mindarie Street','99. M0117 - Crossley Drive',
        '100. M0159 - Trafalgarvale Avenue','101. M0346 - Celsa Street','102. M0144 - Paulina Street',
        '103. M0121 - Goodall Street','104. M0372 - Goodall Street - Janelle Court Park','105. M0128 - Janelle Court Park',
        '106. M0376 - Janelle Court','107. M0377 - Janelle Court - Main Road','108. M0340 - Belford Drive - Main Road (inc to 599)',
        '109. M0032 - Duncan Street','110. M0434 - Warlow Close','111. M0360 - Farnham Street','112. M0108 - Belford Drive',
        '113. M0379 - Laurance Court','114. M1544 - Starkey Street','115. M0152 - Schonrock Street 2',
        '116. M0151 - Schonrock Street 1','117. M0397 - North Haven Place','118. M0126 - Hoskins Parks Drive',
        '119. M0808 - Cashmere Court','120. M0371 - Gilchrist Street Pathway','121. M0156 - Starkey Street',
        '122. M0335 - Anhs Place','123. M0400 - Poloni Place','124. M0423 - Starkey Street',
        '125. M0155 - Starkey and Hertiage Drive','126. M0124 - Heritage Drive','127. M0125 - Hilliards Park Drive',
        '128. M0038 - Sturgeon Street','129. M0349 - Charles Canty Drive','130. M0373 - Grosvenor Court',
        '131. M0365 - Forsyth Place - Leonard Street','132. M0142 - Montgomery Drive',
        '133. M0403 - Queensbury Court - Allenby Road','134. M0158 - Sylvania Street',
        '135. M0129 - Jasper Street','136. M0351 - Cherry and Jasper Street','137. M0150 - Rosella Street Park',
        '138. M0153 - Spurs Drive','139. M0148 - Riverton Drive','140. M0161 - Tulloch Drive','141. M0401 - Prunda Circuit'
      ],
      /* ‚Ä¶ remaining suburb data unchanged ‚Ä¶ */
      'Alexandra Hills': [/* ‚Ä¶ */],
      'Capalaba': [/* ‚Ä¶ */],
      'Ormiston': [/* ‚Ä¶ */],
      'Cleveland': [/* ‚Ä¶ */],
      'Thornlands': [/* ‚Ä¶ */],
      'Victoria Point': [/* ‚Ä¶ */],
      'Redland Bay': [/* ‚Ä¶ */],
      'Mt Cotton': [/* ‚Ä¶ */]
    };

    const listEl   = document.getElementById('assignParksList');
    const searchEl = document.getElementById('suburbSearch');
    const addSelBtn= document.getElementById('addSelectedSuburbs');

    const selectedMap = new Map(); // siteId -> {siteId, suburb, label}

    function parseSiteId(line){
      const m = line.match(/\bM\d+\b/i);
      return m ? m[0].toUpperCase() : '';
    }

    // Build item li
    function makeItem(suburb, text){
      const siteId = parseSiteId(text);
      const li = document.createElement('li');
      li.innerHTML = `
        <input type="checkbox" data-site-id="${siteId}" data-suburb="${suburb}" />
        <span class="site-label">${text}</span>
        <button type="button" class="note-btn" data-site-id="${siteId}" data-suburb="${suburb}" title="Add/View note">üìù</button>
      `;
      return li;
    }

    function buildSuburbWithItems(name, idx){
      const details = document.createElement('details');
      details.className = 'suburb-details';

      const summary = document.createElement('summary');
      const left = document.createElement('div');
      left.className = 'summary-left';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`suburb_${idx}`;
      const lab = document.createElement('label'); lab.setAttribute('for',`suburb_${idx}`); lab.textContent = name;
      left.appendChild(cb); left.appendChild(lab);

      const right = document.createElement('div');
      right.className = 'summary-right';
      right.innerHTML = `<input id="selall_${idx}" type="checkbox" data-suburb-select-all data-suburb="${name}">
                         <label for="selall_${idx}">Select All</label>`;

      summary.appendChild(left); summary.appendChild(right);
      details.appendChild(summary);

      const ol = document.createElement('ol'); ol.className='suburb-sites';
      (SUBURB_ITEMS[name]||[]).forEach(line => ol.appendChild(makeItem(name, line)));
      details.appendChild(ol);

      // select all handling
      right.querySelector('[data-suburb-select-all]').addEventListener('change', (e)=>{
        const checked = e.target.checked;
        ol.querySelectorAll('input[type="checkbox"][data-site-id]').forEach(box=>{
          box.checked = checked;
          box.dispatchEvent(new Event('change', {bubbles:true}));
        });
      });

      return details;
    }

    function buildSimpleSuburb(name, idx){
      const li = document.createElement('li'); li.className='suburb-row';
      const left = document.createElement('div'); left.className='suburb-row-left';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`suburb_${idx}`; cb.value=name;
      const lab = document.createElement('label'); lab.setAttribute('for',`suburb_${idx}`); lab.textContent=name;
      left.appendChild(cb); left.appendChild(lab);
      const add = document.createElement('button'); add.className='mini'; add.type='button'; add.textContent='Add';
      add.addEventListener('click', ()=>{ _basket.push({zone:name, siteIds:[]}); renderBasket(); });
      li.appendChild(left); li.appendChild(add);
      return li;
    }

    function renderList(filter=''){
      listEl.innerHTML='';
      const q=(filter||'').trim().toLowerCase();
      SUBURBS.filter(s=>!q||s.toLowerCase().includes(q)).forEach((name,i)=>{
        if(Array.isArray(SUBURB_ITEMS[name]) && SUBURB_ITEMS[name].length){
          listEl.appendChild(buildSuburbWithItems(name, i));
        }else{
          listEl.appendChild(buildSimpleSuburb(name, i));
        }
      });
      if(!listEl.children.length){
        const p=document.createElement('p'); p.className='muted-note'; p.textContent='No suburbs match your search.'; listEl.appendChild(p);
      }
    }
    renderList();
    searchEl.addEventListener('input', e=>renderList(e.target.value));

    // Live-sync ticks ‚Üí Tasks
    function rebuildBasketFromSelection(){
      const grouped = new Map(); // suburb -> [ids]
      selectedMap.forEach(({siteId, suburb})=>{
        if(!grouped.has(suburb)) grouped.set(suburb, []);
        grouped.get(suburb).push(siteId);
      });

      _basket.length=0;
      grouped.forEach((ids, suburb)=> _basket.push({zone:suburb, siteIds:ids}));
      renderBasket();
    }

    listEl.addEventListener('change', (e)=>{
      const t = e.target;
      if(t.matches('input[type="checkbox"][data-site-id]')){
        const id=t.dataset.siteId, suburb=t.dataset.suburb, label=t.closest('li')?.querySelector('.site-label')?.textContent || id;
        if(t.checked) selectedMap.set(id, {siteId:id, suburb, label});
        else selectedMap.delete(id);
        rebuildBasketFromSelection();
      }
    });

    addSelBtn.addEventListener('click', ()=>{
      // also push currently ticked ‚Äúsimple suburbs‚Äù
      listEl.querySelectorAll('.suburb-row input[type="checkbox"]:checked').forEach(cb=>{
        _basket.push({zone:cb.value, siteIds:[]});
      });
      renderBasket();
    });

    // ---------- Permanent Notes (Firestore: parkNotes/{siteId}) ----------
    const modal = document.getElementById('noteModal');
    const noteTitle = document.getElementById('noteModalTitle');
    const noteTextarea = document.getElementById('noteTextarea');
    const noteSaveBtn = document.getElementById('noteSaveBtn');
    const noteHint = document.getElementById('noteHint');
    const noteCloseBtn = document.getElementById('noteCloseBtn');

    let _currentNote = { siteId:'', suburb:'', button:null };

    async function loadNote(siteId){
      try{
        const d = await db.collection('parkNotes').doc(siteId).get();
        return d.exists ? (d.data().text||'') : '';
      }catch(_){ return ''; }
    }
    async function saveNote(siteId, suburb, text){
      const payload = {
        siteId, suburb, text,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser ? currentUser.uid : null
      };
      await db.collection('parkNotes').doc(siteId).set(payload, {merge:true});
    }

    function openNote(siteId, suburb, buttonEl){
      _currentNote = { siteId, suburb, button: buttonEl };
      noteTitle.textContent = `Note ‚Äî ${siteId} (${suburb})`;
      noteTextarea.value = 'Loading‚Ä¶';
      noteSaveBtn.disabled = !_isAdmin;
      noteHint.textContent = _isAdmin ? '' : 'View-only: you are not an admin.';

      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');

      loadNote(siteId).then(txt=>{
        noteTextarea.value = txt || '';
        if(txt && buttonEl){ buttonEl.classList.add('has-note'); }
      }).catch(()=>{
        noteTextarea.value = '';
      });
    }
    function closeNote(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    noteCloseBtn.addEventListener('click', closeNote);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeNote(); });
    noteSaveBtn.addEventListener('click', async ()=>{
      if(!_isAdmin){ return; }
      try{
        await saveNote(_currentNote.siteId, _currentNote.suburb, noteTextarea.value.trim());
        if(_currentNote.button){ _currentNote.button.classList.toggle('has-note', !!noteTextarea.value.trim()); }
        toast('Note saved');
        closeNote();
      }catch(e){
        console.warn(e); toast('Failed to save note');
      }
    });

    // Open modal from any üìù button
    listEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.note-btn');
      if(!btn) return;
      const siteId = btn.dataset.siteId || '';
      const suburb = btn.dataset.suburb || '';
      if(!siteId) return;
      openNote(siteId, suburb, btn);
    });
  </script>
</body>
</html>
