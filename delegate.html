<!doctype html>
<html lang="en">
<head>

  <!-- Leaflet map CSS/JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside — Delegate tasks</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght:400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24; --focus:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 22px; background:#fff; border-bottom:1px solid var(--muted); position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:14px }
    .brand img{ height:56px; display:block }
    .title{ font-size:22px; font-weight:800; color:var(--ink-2) }
    .userbox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .email{ font-weight:600; color:#334155; background:#f1f5f9; border:1px solid #e2e8f0; padding:8px 10px; border-radius:10px; }
    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff; background:var(--ink); }
    .btn:hover{ background:#1f2937 }

    /* Layout */
    .container{ max-width:1200px; margin: 20px auto; padding: 0 16px }
    .grid{ display:grid; grid-template-columns: 280px 1fr 360px; gap:16px }
    .card{ background:var(--card); border:1px solid var(--muted); border-radius:16px; box-shadow:0 8px 26px rgba(16,24,40,.08); }
    .card h3{ margin:14px 16px 10px; font-size:16px; font-weight:800; color:var(--ink-2) }
    .card .body{ padding: 0 16px 16px }
    
    .grid{
  display:grid;
  grid-template-columns: 1fr 360px;  /* Map grows, right panel fixed */
  gap:16px;
}
@media (max-width:1100px){
  .grid{ grid-template-columns: 1fr; }
}
    
    /* Left: Filters / (optional) sidebar */
    .side label{ display:block; font-weight:700; margin:12px 0 6px }
    .side input, .side select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--muted); background:#fff; font-size:14px;
    }
    .side input:focus, .side select:focus{ outline:3px solid var(--focus); border-color:#94a3b8 }

    /* Center: map placeholder (replace with your real map) */
    .map-wrap{  
      height: min(70vh, 800px);
      display:flex; align-items:center; justify-content:center; color:#64748b; 
    }
    .map-wrap .placeholder{
      <div class="map-wrap" id="map">
      <div id="leafletMap" style="height:100%; width:100%; border-radius:16px;"></div>
      </div>
      text-align:center; border:2px dashed #cbd5e1; padding:20px; border-radius:16px; width:90%;
    }

    /* Right: operator + basket */
    .stack{ display:grid; gap:10px }
    .row{ display:flex; gap:10px }
    .row > *{ flex:1 }
    .strong{ font-weight:800 }
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
      background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
    }
    .half{ display:grid; gap:6px }
    .btn-accent{ background:var(--accent) }
    .btn-accent:hover{ background:var(--accent-600) }

    .basket{ display:grid; gap:8px; margin-top:6px; max-height:260px; overflow:auto; padding-right:6px }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;
      font-weight:700;
    }
    .item small{ font-weight:600; color:#64748b }
    .item .del{
      border:0; border-radius:8px; padding:6px 8px; font-weight:800; background:#f43f5e; color:#fff; cursor:pointer;
    }
    .item .del:hover{ background:#be123c }

    .foot{ display:flex; gap:10px; margin-top:12px }
    .grow{ flex:1 }

    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111827; color:#fff;
      padding:12px 14px; border-radius:10px; font-weight:700; box-shadow:0 10px 24px rgba(0,0,0,.25); display:none; z-index:50;
    }
    .toast.show{ display:block }

    @media (max-width:1100px){ .grid{ grid-template-columns: 1fr } .map-wrap{ height: 360px } }
  </style>
</head>
<body>

  <!-- Firebase + guard (load ONCE) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <img src="logo.png" alt="Bayside logo" onerror="this.style.display='none'">
      <div class="title">Delegate tasks</div>
    </div>
    <div class="userbox">
      <div id="userEmail" class="email">—</div>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="grid">
      <!-- Left column: filters / future sidebar -->
     

      <!-- Center: Map placeholder -->
      <section class="card">
        <h3>Map</h3>
        <div class="body">
          <div class="map-wrap" id="map">
            <div class="placeholder">
              Map goes here.<br>
              <small>Hook in your existing map and call <code>window.addToBasket({zone, range, siteIds})</code> on selection.</small>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Operator + Basket -->
      <aside class="card">
        <h3>Assignment</h3>
        <div class="body">
          <div class="stack">
            <div class="half">
              <label class="strong" for="operatorSelect">Operator</label>
              <select id="operatorSelect" required>
                <option disabled selected>Loading operators…</option>
              </select>
              <small style="color:#64748b">Pulls from <b>users</b> where <code>role == "operator"</code>.</small>
            </div>

            <div class="half" id="quickAdd">
              <label class="strong">Quick add — Zone & Range</label>
              <div class="row">
                <input id="qa_zone" placeholder="Zone 1" />
                <input id="qa_range" placeholder="1–50" />
              </div>
              <button class="btn btn-accent" id="qa_add" type="button">Add to basket</button>
            </div>

            <div class="half">
              <label class="strong">Add by specific site IDs</label>
              <input id="ids_input" placeholder="e.g. 12, 18, 21" />
              <button class="btn btn-accent" id="ids_add" type="button">Add to basket</button>
            </div>

            <div class="half">
              <label>Notes (optional)</label>
              <input id="note_input" placeholder="e.g., High priority, access after 10am" />
            </div>

            <div class="half">
              <label>Due date (optional)</label>
              <input id="due_input" type="date" />
            </div>

            <div class="half">
              <label class="strong">Basket</label>
              <div id="basket" class="basket"></div>
            </div>

            <div class="foot">
              <button class="btn grow" id="assignBtn" type="button">Assign tasks</button>
              <button class="btn" id="clearBtn" type="button" style="background:#64748b">Clear</button>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // --- Tiny toast helper ---
    function toast(msg, ms=2200){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    // --- Global basket APIs (so your map/sidebar can push selections) ---
    window.addToBasket = function(item){
      // item: { zone?:string, range?:string, siteIds?:string[] }
      const norm = {
        zone: (item.zone||'').trim(),
        range: (item.range||'').trim(),
        siteIds: Array.isArray(item.siteIds) ? item.siteIds : []
      };
      _basket.push(norm);
      renderBasket();
    };
    window.clearBasket = function(){ _basket.length = 0; renderBasket(); };

    // --- App state ---
    const db = firebase.firestore();
    let currentUser = null;
    let _basket = [];      // { zone, range, siteIds[] }
    let _operators = [];   // cached operators for later use (name/email lookup)

    // --- DOM ---
    const emailEl   = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const operatorSelect = document.getElementById('operatorSelect');
    const qaZone   = document.getElementById('qa_zone');
    const qaRange  = document.getElementById('qa_range');
    const qaAddBtn = document.getElementById('qa_add');

    const idsInput = document.getElementById('ids_input');
    const idsAdd   = document.getElementById('ids_add');

    const noteInput = document.getElementById('note_input');
    const dueInput  = document.getElementById('due_input');

    const basketEl  = document.getElementById('basket');
    const assignBtn = document.getElementById('assignBtn');
    const clearBtn  = document.getElementById('clearBtn');

    // --- Auth gate ---
    firebase.auth().onAuthStateChanged(async (u)=>{
      if(!u){ location.href = 'login.html'; return; }
      currentUser = u;
      emailEl.textContent = u.email || 'Signed in';
      loadOperators();
    });

    logoutBtn.addEventListener('click', async ()=>{
      try{ await firebase.auth().signOut(); location.href = 'login.html'; }
      catch(e){ console.warn(e); toast('Logout failed'); }
    });

    // --- Operators loader (live)
    (function () {
      const OP_DOMAIN = 'operators.bayside-maps.local'; // for synthetic usernames
      function labelForUser(u){
        if (u.username) return u.username;
        if (u.email && u.email.endsWith('@'+OP_DOMAIN)) return u.email.replace('@'+OP_DOMAIN,'');
        return u.email || 'unknown';
      }
      window.loadOperators = function(){
        db.collection('users').where('role','==','operator').onSnapshot(
          (snap)=>{
            const ops=[]; snap.forEach(doc=>ops.push({ uid: doc.id, ...doc.data() }));
            _operators = ops.slice(); // cache for later
            ops.sort((a,b)=> labelForUser(a).localeCompare(labelForUser(b)));
            operatorSelect.innerHTML = '';
            if(!ops.length){
              operatorSelect.innerHTML = '<option disabled selected>No operators found</option>';
              return;
            }
            const ph = document.createElement('option');
            ph.disabled = true; ph.selected = true; ph.textContent = 'Select operator…';
            operatorSelect.appendChild(ph);
            for(const u of ops){
              const opt = document.createElement('option');
              opt.value = u.uid;
              opt.textContent = labelForUser(u);
              opt.dataset.email = u.email || '';
              opt.dataset.username = u.username || '';
              operatorSelect.appendChild(opt);
            }
          },
          (err)=>{
            console.error('load operators error', err);
            operatorSelect.innerHTML = '<option disabled selected>Error loading operators</option>';
          }
        );
      };
    })();

    // --- Basket UI ---
    function renderBasket(){
      basketEl.innerHTML = '';
      if(_basket.length === 0){
        const p = document.createElement('p');
        p.style.color = '#64748b';
        p.textContent = 'Basket is empty. Add items by Zone & Range or by Site IDs.';
        basketEl.appendChild(p);
        return;
      }
      _basket.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'item';
        const left = document.createElement('div');
        const z = it.zone ? `<span class="pill">${it.zone}</span>` : '';
        const r = it.range ? ` — <small>${it.range}</small>` : '';
        const s = (it.siteIds && it.siteIds.length) ? ` — <small>${it.siteIds.join(', ')}</small>` : '';
        left.innerHTML = `${z}${r}${s}`;
        const del = document.createElement('button');
        del.className = 'del';
        del.textContent = 'Remove';
        del.onclick = ()=>{ _basket.splice(idx,1); renderBasket(); };
        row.appendChild(left);
        row.appendChild(del);
        basketEl.appendChild(row);
      });
    }

    // Quick add handlers
    qaAddBtn.addEventListener('click', ()=>{
      const z = (qaZone.value||'').trim(); const r = (qaRange.value||'').trim();
      if(!z && !r){ toast('Enter Zone and/or Range'); return; }
      addToBasket({ zone:z, range:r, siteIds:[] });
      qaRange.value=''; // keep zone, clear range
    });

    idsAdd.addEventListener('click', ()=>{
      const raw = (idsInput.value||'').trim();
      if(!raw){ toast('Enter at least one site ID'); return; }
      const ids = raw.split(',').map(s=>s.trim()).filter(Boolean);
      addToBasket({ zone:'', range:'', siteIds: ids });
      idsInput.value='';
    });

    clearBtn.addEventListener('click', ()=> clearBasket() );

    // --- Assign button (writes to Firestore 'assignments') ---
    assignBtn.addEventListener('click', async ()=>{
      const uid = operatorSelect.value;
      if(!uid){ toast('Choose an operator'); return; }
      if(_basket.length === 0){ toast('Basket is empty'); return; }

      try{
        const op = _operators.find(o=>o.uid === uid) || {name:'',email:''};
        const batch = db.batch();
        const now = firebase.firestore.FieldValue.serverTimestamp();
        _basket.forEach(it=>{
          const ref = db.collection('assignments').doc();
          batch.set(ref, {
            userId: uid,
            userName: op.name || op.username || '',
            zone: it.zone || '',
            parksRange: it.range || '',
            siteIds: it.siteIds || [],
            notes: (noteInput.value||''),
            dueDate: dueInput.value ? new Date(dueInput.value) : null,
            status: 'assigned',
            createdAt: now,
            createdBy: currentUser.uid
          });
        });
        await batch.commit();
        toast('Tasks assigned');
        clearBasket();
        noteInput.value=''; dueInput.value='';
      }catch(err){
        console.warn(err);
        toast('Assign failed: ' + (err.message || err.code || 'error'));
      }
    });

    // Optional: deep links
    if(location.hash === '#zone'){ qaZone.focus(); }
  </script>

  <script>
(function () {
  // ====== CONFIG ======
  // Point this to the SAME file ParksMowing uses (update the path if different).
  const GEOJSON_URL = './data/parks-mowing.geojson'; // <-- change if needed

  // Which property acts as your site identifier?
  const SITE_ID_PROP = 'id'; // e.g. 'id', 'siteId', 'NAME' — change if yours differs

  // ====== MAP SETUP ======
  if (!document.getElementById('leafletMap')) return; // safety

  // Create Leaflet map
  const map = L.map('leafletMap', {
    zoomControl: true,
    attributionControl: false
  });

  // A neutral basemap (free & no token)
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // Styles
  const defaultStyle = {
    color: '#1d4ed8',      // stroke
    weight: 2,
    opacity: 0.9,
    fillColor: '#60a5fa',  // fill
    fillOpacity: 0.25
  };
  const selectedStyle = {
    color: '#b91c1c',
    weight: 3,
    opacity: 1,
    fillColor: '#ef4444',
    fillOpacity: 0.35
  };

  // Track selected IDs so we can toggle highlight
  const selected = new Set();

  // Toggle selection and add to basket instantly
  function onFeatureClick(e, feature, layer) {
    const props = feature.properties || {};
    const siteId = props[SITE_ID_PROP] || props.id || props.siteId || props.name;
    if (!siteId) return;

    if (selected.has(siteId)) {
      selected.delete(siteId);
      layer.setStyle(defaultStyle);
    } else {
      selected.add(siteId);
      layer.setStyle(selectedStyle);

      // Push straight into your existing basket
      window.addToBasket({
        zone: props.zone || '',        // tweak if your data carries a zone
        range: '',                     // not used here
        siteIds: [String(siteId)]
      });
    }
  }

  // Load & render GeoJSON
  fetch(GEOJSON_URL)
    .then(r => r.json())
    .then(data => {
      const geo = L.geoJSON(data, {
        style: defaultStyle,
        onEachFeature: (feature, layer) => {
          // Hover effect
          layer.on('mouseover', () => layer.setStyle({ weight: 3, fillOpacity: 0.35 }));
          layer.on('mouseout', () => {
            const props = feature.properties || {};
            const siteId = props[SITE_ID_PROP] || props.id || props.siteId || props.name;
            if (selected.has(siteId)) layer.setStyle(selectedStyle);
            else layer.setStyle(defaultStyle);
          });

          // Click to select + add to basket
          layer.on('click', (e) => onFeatureClick(e, feature, layer));

          // Optional popup label
          const props = feature.properties || {};
          const name = props.name || props[SITE_ID_PROP] || 'Site';
          const zone = props.zone ? `Zone: ${props.zone}<br>` : '';
          layer.bindPopup(`<strong>${name}</strong><br>${zone}`);
        }
      }).addTo(map);

      // Fit to bounds nicely
      const b = geo.getBounds();
      if (b.isValid()) map.fitBounds(b.pad(0.05));
      else map.setView([-27.5, 153.2], 11); // fallback center if no bounds
    })
    .catch(err => {
      console.warn('GeoJSON load error:', err);
      const holder = document.getElementById('leafletMap');
      if (holder) holder.innerHTML =
        '<div style="padding:12px;color:#b91c1c;font-weight:700">Failed to load map data.</div>';
    });

})();
</script>

<!-- Leaflet (same as ParksMowing) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Your shared Parks Mowing logic -->
<script src="script.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    BaysideMaps.initParksMowingMap({
      containerId: 'leafletMap',     // mount into delegate map area
      geojsonUrl: 'data.geojson',    // same data as ParksMowing
      onFeatureClick: (feature, layer, evt) => {
        // Pick your site ID field (adjust if yours is called something else)
        const p = feature.properties || {};
        const siteId = p.id || p.siteId || p.NAME || feature.id;
        if (!siteId) return;

        // Send to your existing basket flow
        window.addToBasket({
          zone: p.zone || '',         // keep if you have it in properties
          range: '',
          siteIds: [String(siteId)]
        });

        // Optional: quick visual feedback
        layer.setStyle({ color: '#b91c1c', weight: 3, fillColor: '#ef4444', fillOpacity: 0.35 });
      }
    });
  });
</script>
<!-- Leaflet (same as ParksMowing) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Your shared Parks Mowing logic -->
<script src="script.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    BaysideMaps.initParksMowingMap({
      containerId: 'leafletMap',     // mount into delegate map area
      geojsonUrl: 'data.geojson',    // same data as ParksMowing
      onFeatureClick: (feature, layer, evt) => {
        // Pick your site ID field (adjust if yours is called something else)
        const p = feature.properties || {};
        const siteId = p.id || p.siteId || p.NAME || feature.id;
        if (!siteId) return;

        // Send to your existing basket flow
        window.addToBasket({
          zone: p.zone || '',         // keep if you have it in properties
          range: '',
          siteIds: [String(siteId)]
        });

        // Optional: quick visual feedback
        layer.setStyle({ color: '#b91c1c', weight: 3, fillColor: '#ef4444', fillOpacity: 0.35 });
      }
    });
  });
</script>  

</body>
</html>
