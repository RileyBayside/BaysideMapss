<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Delegate Work</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .card { max-width: 840px; margin: 0 auto; padding: 16px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row + .row { margin-top: 12px; }
    label { font-weight: 600; }
    select, textarea, input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
    textarea { min-height: 110px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .btn-primary { background: #0b5fff; color: #fff; }
    .btn-ghost { background: #f4f6fb; color: #111; }
    .hint { color: #666; font-size: 12px; }
    .pill { padding: 6px 10px; border-radius: 999px; background:#f4f6fb; }
    .hidden { display: none; }
    .ok { color: #137333; }
    .err { color: #b00020; }
    html.auth-checking body { visibility: hidden; } /* avoid flash while gating */
  </style>

  <!-- Admin-only access gate -->
  <script type="module">
    import { app } from "./firebase-init.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    document.documentElement.classList.add("auth-checking");
    const auth = getAuth(app);
    const db   = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) { window.location.href = "/BaysideMapss/login.html"; return; }
        const s = await getDoc(doc(db, "users", user.uid));
        if (!s.exists() || s.data().role !== "admin") {
          window.location.href = "/BaysideMapss/index.html"; return;
        }
      } catch {
        window.location.href = "/BaysideMapss/login.html"; return;
      } finally {
        document.documentElement.classList.remove("auth-checking");
      }
    });
  </script>
</head>
<body>

  <div class="card">
    <h1 style="margin:0 0 8px 0;">Delegate Work</h1>
    <div class="hint">Create an assignment for an operator. Open the maps if you need to cross-check sites before assigning.</div>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label for="operatorSelect">Assign to operator</label>
        <select id="operatorSelect">
          <option value="">Loading operators…</option>
        </select>
        <div class="hint">This list shows users with <code>canReceiveAssignments: true</code>.</div>
      </div>

      <div class="pill">
        <label style="font-weight:600;">Task type:</label>
        <span style="margin-left:8px;">
          <label><input type="radio" name="taskType" value="parks_mowing" checked> Parks Mowing</label>
          &nbsp;&nbsp;
          <label><input type="radio" name="taskType" value="parks_snipping"> Parks Snipping</label>
        </span>
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label for="siteIds">Site IDs to assign</label>
        <textarea id="siteIds" placeholder="e.g.
M0123, M0456
M0789
M0999 M1234"></textarea>
        <div class="hint">Separate IDs by comma, space, or new line. We’ll deduplicate automatically.</div>
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label for="note">Note (optional)</label>
        <input type="text" id="note" placeholder="e.g. Do these by Friday, North zone first."/>
      </div>
    </div>

    <div class="actions">
      <button id="assignBtn" class="btn-primary">Create assignment</button>
      <button id="openMowing" class="btn-ghost" type="button">Open Parks Mowing Map</button>
      <button id="openSnipping" class="btn-ghost" type="button">Open Parks Snipping Map</button>
      <span id="status" class="hint"></span>
    </div>
  </div>

  <script type="module">
    import { app } from "./firebase-init.js";
    import {
      getFirestore, collection, query, where, orderBy, limit,
      getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const db   = getFirestore(app);
    const auth = getAuth(app);

    const operatorSelect = document.getElementById("operatorSelect");
    const assignBtn      = document.getElementById("assignBtn");
    const siteIdsEl      = document.getElementById("siteIds");
    const noteEl         = document.getElementById("note");
    const statusEl       = document.getElementById("status");
    const openMowingBtn  = document.getElementById("openMowing");
    const openSnippingBtn= document.getElementById("openSnipping");

    // --- Populate operators via capability flag (Option B) ---
    async function loadOperators() {
      operatorSelect.innerHTML = `<option value="">Loading operators…</option>`;

      const q = query(
        collection(db, "users"),
        where("canReceiveAssignments", "==", true),
        orderBy("displayName"),
        limit(200)
      );
      const snap = await getDocs(q);

      operatorSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "Select operator…";
      operatorSelect.appendChild(ph);

      if (snap.empty) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No assignable users found";
        operatorSelect.appendChild(opt);
        return;
      }

      snap.forEach(d => {
        const u = d.data();
        const opt = document.createElement("option");
        opt.value = d.id; // uid
        const roleLabel = u.role ? ` (${u.role})` : "";
        opt.textContent = (u.displayName || d.id) + roleLabel; // e.g., "Riley (admin)"
        operatorSelect.appendChild(opt);
      });
    }

    // --- Create assignment ---
    async function createAssignment() {
      statusEl.textContent = "";
      const assigneeUid = operatorSelect.value;
      if (!assigneeUid) { statusEl.textContent = "Please select an operator."; return; }

      // Parse site IDs: split on commas/spaces/newlines, dedupe, strip empties
      const raw = siteIdsEl.value || "";
      const ids = Array.from(new Set(
        raw.split(/[\s,]+/).map(s => s.trim()).filter(Boolean)
      ));
      if (!ids.length) { statusEl.textContent = "Add at least one Site ID."; return; }

      const type = (document.querySelector('input[name="taskType"]:checked')?.value) || "parks_mowing";
      const note = noteEl.value?.trim() || null;

      assignBtn.disabled = true;
      assignBtn.textContent = "Creating…";

      try {
        await addDoc(collection(db, "assignments"), {
          assigneeUid,
          createdByUid: auth.currentUser ? auth.currentUser.uid : null,
          createdAt: serverTimestamp(),
          status: "open",
          note: note,
          items: [ { type, siteIds: ids } ]
        });

        statusEl.innerHTML = `<span class="ok">Assigned ${ids.length} site(s) successfully.</span>`;
        // If you prefer clearing inputs after success, uncomment:
        // siteIdsEl.value = ""; noteEl.value = ""; operatorSelect.value = "";
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">Failed to create assignment. See console for details.</span>`;
      } finally {
        assignBtn.disabled = false;
        assignBtn.textContent = "Create assignment";
      }
    }

    // --- Open maps for reference (no changes to those pages) ---
    openMowingBtn.addEventListener("click", () => {
      window.open("./parksmowing.html", "_blank");
    });
    openSnippingBtn.addEventListener("click", () => {
      window.open("./parkssnipping.html", "_blank");
    });

    // init
    loadOperators();
    assignBtn.addEventListener("click", createAssignment);
  </script>

</body>
</html>
