<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bayside — Admin Dashboard</title>
  <link rel="icon" href="logo.png">

  <!-- Minimal styles (compatible with your existing CSS) -->
  <style>
    :root{--card:#fff;--bg:#f6f7f9;--muted:#6b7280;--black:#0f172a}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--black)}
    .header{display:flex;align-items:center;gap:12px;padding:14px 22px;background:#fff;border-bottom:1px solid #e5e7eb}
    .header img{height:40px}.header .brand{font-weight:800}.header .spacer{flex:1}
    .header .link{text-decoration:none;color:#0f172a;border:1px solid #e5e7eb;padding:8px 12px;border-radius:10px;background:#fff}
    .container{max-width:1100px;margin:22px auto;padding:0 22px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    .btn{margin-top:12px;padding:10px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;font-weight:800}
    .muted{color:#6b7280}.alert{padding:14px;border:1px solid #f3d1d4;background:#fff7f7;border-radius:12px;color:#991b1b;margin-top:14px}
    .msg{margin-top:10px;font-size:14px}.ok{color:#065f46}.err{color:#991b1b}
    .toast{position:fixed;top:16px;right:16px;z-index:9999;display:none}
    .toast .t{min-width:280px;max-width:420px;background:#fff;border:1px solid #e5e7eb;border-left:6px solid #10b981;border-radius:12px;
      box-shadow:0 14px 32px rgba(0,0,0,.12);padding:12px 14px;margin-top:8px}
    .toast .t.err{border-left-color:#ef4444}.toast .title{font-weight:800;margin-bottom:4px}.toast .sub{color:#6b7280;font-size:13px}
  </style>

  <!-- Your auth gate (keep) -->
  <script src="auth.js"></script>
  <script>window.BaysideAuth && BaysideAuth.enforceGate && BaysideAuth.enforceGate();</script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>

  <!-- Your Firebase config -->
  <script src="firebase-init.js"></script>

  <!-- App Check SDK + bootstrap -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-check-compat.js"></script>
  <script src="appcheck.js"></script>

  <!-- Your data helpers -->
  <script src="data.js"></script>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="Bayside">
    <div class="brand">Admin Dashboard</div>
    <div class="spacer"></div>
    <a class="link" href="index.html">Back to Dashboard</a>
  </div>

  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <div class="container">
    <div id="roleGate" class="alert" style="display:none">You must be an admin to view this page.</div>

    <div id="app" style="display:none">
      <div class="grid">
        <div class="card">
          <h3>Operators</h3>
          <div id="operators"></div>
        </div>

        <div class="card">
          <h3>Create Assignment</h3>
          <form id="assignForm" autocomplete="off">
            <label>Operator</label>
            <select id="assignee"></select>
            <label>Zone</label>
            <input id="zone" type="text" placeholder="e.g., Zone 1" />
            <label>Parks (range or list)</label>
            <input id="parksSpec" type="text" placeholder="e.g., 1-50 or M0001-M0050" />
            <label>Notes (optional)</label>
            <textarea id="notes" rows="3" placeholder="Any extra details"></textarea>
            <button class="btn" type="submit">Assign Work</button>
            <div id="msg" class="msg"></div>
          </form>
        </div>

        <div class="card">
          <h3>Create Operator (Username + Password)</h3>
          <form id="createOpForm" autocomplete="off">
            <label>Username (lowercase, no spaces)</label>
            <input id="co_username" type="text" placeholder="e.g., riley" required />
            <label>Password (6+ characters)</label>
            <input id="co_password" type="password" placeholder="e.g., 123456" minlength="6" required autocomplete="new-password" />
            <label>Display name (optional)</label>
            <input id="co_display" type="text" placeholder="e.g., Riley" />
            <button class="btn" type="submit">Create Operator</button>
            <div id="co_msg" class="msg"></div>
          </form>
          <p class="muted">Creates Auth user <code>username@bayside.local</code> and Firestore <code>/users/{uid}</code> with <code>role: "operator"</code>.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toast(type, title, sub){
      const box = document.getElementById('toast');
      const t = document.createElement('div');
      t.className = 't ' + (type === 'error' ? 'err' : '');
      t.innerHTML = '<div class="title">'+ title +'</div>' + (sub ? '<div class="sub">'+ sub +'</div>' : '');
      box.appendChild(t); box.style.display = 'block';
      setTimeout(() => { t.remove(); if (!box.children.length) box.style.display='none'; }, 4500);
    }

    (async function(){
      const role = await BaysideData.getMyRole();
      if (role !== 'admin') { document.getElementById('roleGate').style.display = 'block'; return; }
      document.getElementById('app').style.display = 'block';

      // Filter-only query (no composite index required) + client-side sort
      async function listOperatorsSafe() {
        const db = firebase.firestore();
        const snap = await db.collection('users').where('role', '==', 'operator').get();
        const rows = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        rows.sort((a, b) => (a.name || a.email || '').localeCompare(b.name || b.email || ''));
        return rows;
      }

      let ops = await listOperatorsSafe();
      const list = document.getElementById('operators');
      list.innerHTML = ops.length ? ('<ul>' + ops.map(o => '<li>'+ (o.name||o.email||o.uid) +'</li>').join('') + '</ul>')
                                  : '<div class="muted">No operators found yet.</div>';
      const sel = document.getElementById('assignee');
      sel.innerHTML = ops.map(o => `<option value="${o.uid}">${o.name || o.email || o.uid}</option>`).join('');

      // Create assignment
      document.getElementById('assignForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const uid = sel.value;
        const name = (ops.find(x => x.uid === uid) || {}).name || 'Operator';
        const zone = document.getElementById('zone').value;
        const parksSpec = document.getElementById('parksSpec').value;
        const notes = document.getElementById('notes').value;
        const msg = document.getElementById('msg'); msg.textContent = '';
        try{
          const id = await BaysideData.createAssignment({ assigneeUid: uid, assigneeName: name, zone, parksSpec, notes });
          msg.className = 'msg ok'; msg.textContent = 'Assignment created: ' + id;
          toast('ok', 'Assignment created', 'ID: ' + id);
          e.target.reset();
        }catch(err){
          const code = err.code || (err.details && err.details.code) || 'unknown';
          const message = err.message || (err.details && err.details.message) || 'Failed';
          msg.className = 'msg err'; msg.textContent = code + ' — ' + message;
          toast('error', 'Assignment failed', code + ' — ' + message);
          console.error('Create assignment error:', err);
        }
      });

      // Callable function (set your region)
      const FUNCTIONS_REGION = 'australia-southeast1';
      const createOp = firebase.app().functions(FUNCTIONS_REGION).httpsCallable('adminCreateOperator');

      // Create operator with strong feedback
      document.getElementById('createOpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const u = (document.getElementById('co_username').value || '').trim().toLowerCase();
        const p = (document.getElementById('co_password').value || '').trim();
        const d = (document.getElementById('co_display').value || '').trim();
        const out = document.getElementById('co_msg'); out.textContent = ''; out.className = 'msg';

        if (!/^[a-z0-9._-]{3,}$/.test(u)) {
          out.className='msg err'; out.textContent='invalid-argument — Username must be 3+ chars [a-z, 0-9, . _ -]';
          toast('error', 'Create operator failed', out.textContent); return;
        }
        if (!p || p.length < 6) {
          out.className='msg err'; out.textContent='invalid-argument — Password must be at least 6 characters';
          toast('error', 'Create operator failed', out.textContent); return;
        }

        try{
          const res = await createOp({ username: u, password: p, displayName: d || null });
          out.className='msg ok';
          out.textContent = 'Created operator: ' + res.data.email + ' (uid ' + res.data.uid + ')';
          toast('ok', 'Operator created', res.data.email + ' • uid ' + res.data.uid);
          e.target.reset();

          // refresh operator list
          ops = await listOperatorsSafe();
          list.innerHTML = ops.length ? ('<ul>' + ops.map(o => '<li>'+ (o.name||o.email||o.uid) +'</li>').join('') + '</ul>')
                                      : '<div class="muted">No operators found yet.</div>';
          sel.innerHTML = ops.map(o => `<option value="${o.uid}">${o.name || o.email || o.uid}</option>`).join('');
        }catch(err){
          const code = err.code || (err.details && err.details.code) || 'unknown';
          const message = err.message || (err.details && err.details.message) || 'Failed';
          out.className='msg err';
          out.textContent = code + ' — ' + message;
          toast('error', 'Create operator failed', code + ' — ' + message);
          console.error('Create operator error:', err);
        }
      });
    })();
  </script>
</body>
</html>
